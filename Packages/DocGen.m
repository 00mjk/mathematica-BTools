(* ::Package:: *)


(* ::Title:: *)
(*ProjectManager Package*)

(* ::Text::GrayLevel[.5]:: *)
(*Autogenerated MyProjects package*)

(* ::Subsubsection::Closed:: *)
(*General*)



$DocGenLine::usage=
	"The $Line for writing docs";


(* ::Subsubsection::Closed:: *)
(*RefPages*)



$DocumentationColoring::usage=
	"The coloring table for auto-generated documentation";
$DocActive::usage=
	"The application actively being documented";
$DocLinkBase::usage=
	"The ref link base for docs";
DocLinkBase::usage=
	"Wrapper function for $DocLinkBase";
$DocFooter::usage=
	"The default footer to use when making doc pages";


AutoGenerateUsage::usage=
	"Automatically provides usage info for a function based on usage messages and *Values";
AutoGenerateExamples::usage=
	"Automatically provides examples for a function based on *Values";
AutoGenerateDetails::usage=
	"Automatically provides details for a function";


RefPageNotebook::usage=
	"Creates a documentation notebook";
GenerateRefPages::usage=
	"Opens a documentation notebook";
SaveRefPages::usage=
	"Saves the documentation pages to a directory";


RefPageRefLink::usage="Generates RefLink boxes to a symbol";
RefPageTemplate::usage="Makes a template cell group to fill out from";
RefPageContextTemplate::usage="Makes a template notebook for a context";


(* ::Subsubsection::Closed:: *)
(*Guide*)



GuideNotebook::usage=
	"Formats a guide notebook from a spec";
GenerateGuide::usage=
	"Generates a guide from a spec or from a template";
SaveGuide::usage=
	"Saves a guide in a directory";
GuideTemplate::usage=
	"Generates a template to build a guide from";
GuideContextTemplate::usage=
	"Generates a template that autofills with all the function in a context";


(* ::Subsubsection::Closed:: *)
(*Tutorial*)



TutorialNotebook::usage=
	"Formats a tutorial notebook from a spec";
GenerateTutorial::usage=
	"Generates a tutorial from a spec or from a template";
TutorialContextTemplate::usage=
	"Generates a template that autofills with all the function in a context";
TutorialTemplate::usage=
	"Generates a template to build a tutorial from";


(* ::Subsubsection::Closed:: *)
(*Helpers*)



IndexDocumentation::usage=
	"Generates an index for documentation located in a directory";


GenerateDocumentation::usage=
	"Generates and documentation and saves it in a basic documentation paclet";


DocAddUsage::usage=
	"Adds a usage to the usages for a symbol";


Begin["`Private`"];


(* ::Subsection:: *)
(*Utils*)



If[!IntegerQ@$DocGenLine,$DocGenLine=0];


$docGen="DocGen`Private`";
docGenBlock[cmd_]:=(
	Begin[$docGen];
	CheckAbort[(End[];#)&@cmd,If[$Context==$docGen,End[]]]
	);
docGenBlock~SetAttributes~HoldFirst


If[Length@OwnValues@$DocActive==0,
	$docActive=None;
	$DocActive:=
		Replace[$docActive,
			Except[_String]:>
				Replace[Quiet@NotebookFileName[],{
					f_String:>
						FileNameTake[f,
							{FileNameDepth@$AppDirectory+1}
							],
					$Failed->"System"
					}]
			];
	$DocActive/:
		HoldPattern[Set[$DocActive,v_]]:=
			Set[$docActive,v];
	$DocActive/:
		HoldPattern[SetDelayed[$DocActive,v_]]:=
			SetDelayed[$docActive,v];
	$DocActive/:
		HoldPattern[Unset[$DocActive]]:=
			$docActive=None;
	];


If[MatchQ[$DocLinkBase,Except[{__Rule}]],
	$DocLinkBase={
		"System"->
			Nothing
		};
	];
DocLinkBase[s_String]:=
	StringJoin@Most@
		StringSplit[
			Which[
				StringContainsQ[s,"`"],
					s,
				StringContainsQ[s,"\""],
					"Global`"<>s,
				True,
					ToExpression[s,StandardForm,
						Function[Null,
							Replace[Unevaluated[#],{
								sym_Symbol:>
									Context[sym]<>"`bloobybloop",
								e_:>(
									"System"
									)
								}],
							HoldFirst
							]
						]
				],
			"`"]/.
			Append[Replace[$DocLinkBase,Except[_List]:>{}],
				a_:>
					With[{app=Replace[a,"Global"|"DocGen":>$DocActive]},
						If[FileExistsQ@AppDirectory[app,"PacletInfo.m"],
							Replace[AppPacletInfo[app]["Documentation","LinkBase"],{
								Except[_String]->app
								}],
							app]
						]
				];
DocLinkBase[s_Symbol]:=
	DocLinkBase@Context@s;
DocLinkBase[e:Except[_Symbol|_String]]:=
	DocLinkBase@Evaluate[e];
DocLinkBase~SetAttributes~HoldFirst;


symString=
	StringMatchQ[
		("$"|"`"|LetterCharacter)~~
			(("$"|"`"|WordCharacter)...)];


italString=StringMatchQ[("$"|"`"|WordCharacter)..~~(Whitespace|"")];


makeRefOverrides=
	{
		
		};


makeRefTest=(
	MemberQ[makeRefOverrides,#]||(
		symString[#]&&
			Replace[
				ToExpression[#,StandardForm,Hold],
				Hold[s_]:>(
					Not@MatchQ[
						Context[s],
						$Context|"Global`"
						]&&(
						GeneralUtilities`HasDefinitionsQ[#]||
						System`Private`HasAnyCodesQ[s]||
						Length@Messages[s]>0||
						Length@DeleteCases[Attributes[#],Temporary]>0
						)
					)]
			)
		)&;


holdPatternStrippedBoxes[pattern_]:=
	Replace[Unevaluated[pattern],{
		Verbatim[HoldPattern][e_]:>
			holdPatternStrippedBoxes[e],
		e_:>
			ToBoxes@Unevaluated[e]
		}];
holdPatternStrippedBoxes~SetAttributes~HoldFirst;


pacletLinkBuild//Clear;


pacletLinkBuild[s_,context_,type_]/;$pacletBuildLink:=
	URLDecode@
		URLBuild[<|
			"Scheme"->"paclet",
			"Path"->
				Flatten@{
					Replace[context,"System"->Nothing],
					type,
					StringSplit[s,"`"]//Last	
					}
			|>];
pacletLinkBuild[s_,type_]/;$pacletBuildLink:=
	With[{base=
		Replace[s,{
			Except[_String]:>
				$DocActive
			}]},
		pacletLinkBuild[s,DocLinkBase@base,type]
		];
pacletLinkBuild[s_]/;$pacletBuildLink:=
	pacletLinkBuild[s,"ref"];
pacletLinkBuild[s_,e___]:=
	Which[
		MatchQ[s,_String?(StringMatchQ["paclet:*"])],
			s,
		Length@
			DeleteCases[""|_String?(StringMatchQ[Whitespace])]@
			URLParse[s,"Path"]>1,
			URLDecode@
				URLBuild@Prepend[URLParse[s],"Scheme"->"paclet"],
		True,
			Block[{$pacletBuildLink=True},
				pacletLinkBuild[s,e]
				]
		];


If[MatchQ[$DocumentationColoring,{Except[_Rule]..}|Except[_List]],
	$DocumentationColoring={
		"BUILT-IN SYMBOL"->RGBColor[0.023529, 0.427451, 0.729412],
		"GUIDE"->RGBColor[0.8, 0.4, 0],
		"TUTORIAL"->RGBColor[0.641154, 0.223011, 0.0623026],
		"BTools"->Hue[0.7, 0.5, 0.79],
		"Global"->Hue[0.99, 0.6900000000000001, 0.71],
		"Package"->Hue[0.6, 0.3, 0.7]
		}
	];


If[MatchQ[$DocumentationLinkStyle,{Except[_Rule]..}|Except[_List]],
	$DocumentationLinkStyle={
		"System"->
			"RefLink",
		"Global"->
			"RefLink",
		"BTools"->
			"PackageLink"
		}
	];


docSymType[sym_Symbol]:=
	Replace[
		StringReplace[
			Context@sym,
			Except[WordCharacter|"$"]->""
			],{
		"System"->
			"BUILT-IN SYMBOL"
		}];
docSymType~SetAttributes~HoldFirst;


docTypeColor[s_]:=
	s/.Append[$DocumentationColoring,_->GrayLevel[0.5]]


docLinkType[sym_Symbol]:=
	Replace[DocLinkBase[sym],
		Nothing->"System"
		]/.
		Append[$DocumentationLinkStyle,
			_->"PackageLink"];
docLinkType~SetAttributes~HoldFirst;


(* ::Subsection:: *)
(*RefPages*)



RefPageRefLink[s_String,cell:True|False:True]:=
	Cell@*BoxData@
		TemplateBox[
			{
				Cell[TextData[Last@StringSplit[s,"`"]]],
				pacletLinkBuild[s]
				},
			"RefLink",
			BaseStyle->{"InlineFormula"}
			];
RefPageRefLink[s_Symbol]:=
	With[{sname=SymbolName@Unevaluated[s]},
		RefPageRefLink[sname]
		];
RefPageRefLink[h_Hyperlink]:=
	Cell[BoxData@ToBoxes@h,"Hyperlink"];
RefPageRefLink[e_?BoxQ]:=
	e/.s_String?makeRefTest:>RefPageRefLink[s];
RefPageRefLink~SetAttributes~HoldFirst


parseRefText[t_]:=
	ReplaceAll[
		ReplaceAll[t,
			StyleBox[ital_?symString,
   		 FontSlant->"Italic"]:>
   			 StyleBox[ital,"TI"]
			],
		Cell[
			BoxData[FormBox[s_,_?(ToString[#]=="InlineRef"&)]],
			___
			]:>
			Replace[s,{
				_String?makeRefTest:>
					RefPageRefLink[s],
				"..."->
					StyleBox["...","TI"],
				SubscriptBox[a_,b_]:>
					Cell[
						BoxData@SubscriptBox[
							StyleBox[a,"TI"],
							StyleBox[b,"TI"]
							],
						FormatType->TraditionalForm],
				Except[_TextData]:>
						Cell[Replace[b:Except[_BoxData]:>BoxData[b]]@
							ReplaceAll[s,{
								hold:TemplateBox[___,"RefLink",___]:>
									hold,
								hold:(StyleBox|FormBox)[f_,e___]:>
									StyleBox[parseRefText[f],e],
								ref_String?makeRefTest:>
									RefPageRefLink[ref],
								r_String?(StringMatchQ["\"*\""]):>
									Cell[
										BoxData@
											StyleBox[r,"InlineFormula","Input"],
										FormatType->StandardForm
										],
								SubscriptBox[a_,b_]:>
									Cell[
										BoxData@SubscriptBox[
											StyleBox[a,"TI"],
											StyleBox[b,"TI"]
											],
										FormatType->TraditionalForm
										]
								}],
							"InlineFormula"
							]
				}]
		];


sectionOpener=
	Style[
 	Graphics[{
 		Thickness[0.18],
 		RGBColor[0.8509803921568627, 0.396078431372549, 0],
 		Line[{{-1.8, 0.5}, {0, 0}, {1.8, 0.5}}]}, 
 			AspectRatio -> 1, PlotRange -> {{-3, 4}, {-1, 1}},
 		ImageSize -> 20],
 	Magnification -> 0.68*Inherited];


With[{sectionOpener=sectionOpener},
	sectionsToggler[sectionIDs__]:=
		With[{list=DeleteCases[{TaggingRules, "Openers", sectionIDs},None]},
			Toggler[
				Dynamic[
					MatchQ[
						CurrentValue[EvaluationNotebook[],list,Closed],
						Open|True
						],
					CurrentValue[EvaluationNotebook[],list]=#;&,
					ImageSizeCache->{14.,{5.,9.}}
					],
				Thread[{True,False}->{sectionOpener,Rotate[sectionOpener,\[Pi]/2,{-1.65,-1}]}]
				]
			]
	]


openerText[text_,ids__]:=
	TextData@{
		Cell@BoxData@
			With[{toggle=sectionsToggler[ids]},
				DynamicBox[
					If[ $VersionNumber < 11.1,
						"",
						Cell[BoxData@ToBoxes@toggle]
						],
				UpdateInterval->Infinity
				]
			],
		text
		};


openerCell[text_,style_,id:_String|None:None,ops___?OptionQ]:=
	Cell[openerText[text,style,id],
		style,
		System`WholeCellGroupOpener->True,
		ops
		];


openerCellGroup[{text_,style_,id:_String|None:None,ops___?OptionQ},
	subcells___
	]:=
	Cell@
		CellGroupData[Flatten@{
			openerCell[text,style,id,ops],
			subcells
			},
				With[{idlist=
					If[id===None,
						{TaggingRules, "Openers",style},
						{TaggingRules, "Openers",style,id}
						]},
					Dynamic@
						CurrentValue[EvaluationNotebook[],
							idlist,
							Closed
							]
					]
			];


generateSymRefs[seeAlso_]:=
	With[{
		names=
			Replace[
				Replace[Thread[Hold[seeAlso]],
					Hold[h_Hold]:>h,
					1],{
				Hold[s_Symbol]:>
					SymbolName@Unevaluated[s],
				Hold[k_->v_String]:>
					k->"paclet:"<>v
				},
				1]},
		Replace[names,{
			s_String:>
				With[{p=pacletLinkBuild[s,"ref"]},
					s:>Documentation`HelpLookup[p]
					],
			(k_->v_):>
				k:>Documentation`HelpLookup[v]
			},
			1]
		];
generateSymRefs~SetAttributes~HoldFirst;


generateGuideRefs[guides_]:=
	With[{g=pacletLinkBuild[Last@#,"guide"]},
		First@#:>Documentation`HelpLookup[g,EvaluationNotebook[]]
		]&/@
		Replace[guides,
			s_String:>(s->s),
			1];


generateUrlRefs[refString_String]:=
	{
		refString:>None,
		"Copy Documentation Center URI":>CopyToClipboard@refString,
		Delimiter,
		"Copy web URL":>
			CopyToClipboard@
				Hyperlink[URLBuild[{"http://reference.wolfram.com/language",refString}]],
		"Go to URL":>
			SystemOpen@URLBuild[{"http://reference.wolfram.com/language",refString}]
		};
generateUrlRefs[ref_Symbol]:=
	generateUrlRefs@
		Evaluate@
			StringTrim[pacletLinkBuild@ToString@Unevaluated[ref],
				"paclet:"
				];
generateUrlRefs~SetAttributes~HoldFirst;


docSymbolNameToString[sym_Symbol]:=
	SymbolName@Unevaluated[sym];
docSymbolNameToString[s_]:=
	ToString@Unevaluated[s];
docSymbolNameToString~SetAttributes~HoldFirst;


docArrow=Graphics[{{{{{{{{{{{{{GrayLevel[0.66667], Thickness[0.13], Line[{{-1.8, 0.5}, {0, 0}, {1.8, 0.5}}]}}}}}}}}}}}}}, AspectRatio -> 1, ImageSize -> 20, PlotRange -> {{-3, 4}, {-1, 1}}];


iGenerateAnchorBar[sym_,seeAlso_,relatedGuides_]:=
	Cell[
		BoxData@
			ToBoxes@
				Grid[{{
					Grid[{{
						Item[
							Row@{
								Spacer[8],
								RawBoxes@
									Cell[
										StringTrim[
											ToUpperCase@docSymType@sym,
											" SYMBOL"<>" SYMBOL"
											],
										"PacletNameCell",
										TextAlignment->Center],
								Spacer[8]
								},
							Background->docTypeColor[docSymType@sym],
							ItemSize->Full]
							}},
						Alignment->{Automatic,Center},
						ItemSize->{
							{Full,Scaled[0.02`]},
							2.5
							}],
					RawBoxes@
						Cell[
							TextData@
								Riffle[{
									Cell[
										BoxData@ToBoxes@
											ActionMenu[Row@{"See Also","  ",docArrow},
												generateSymRefs[seeAlso],
												Appearance->None,MenuAppearance->Automatic,
												BaseStyle->"AnchorBarActionMenu",
												MenuStyle->"SeeAlso"
												]
										],
									Cell[
										BoxData@ToBoxes@
											ActionMenu[Row@{"Related Guides","  ",docArrow},
												generateGuideRefs[relatedGuides],
												Appearance->None,MenuAppearance->Automatic,
												BaseStyle->"AnchorBarActionMenu",
												MenuStyle->"MoreAbout"
												]
										],
									Cell[
										BoxData@ToBoxes@
											ActionMenu[Row@{"URL","  ",docArrow},
												generateUrlRefs[sym],
												Appearance->None,MenuAppearance->Automatic,
												BaseStyle->"AnchorBarActionMenu",
												MenuStyle->"URLMenu"
												]
										]
									},
								"\[ThickSpace]\[ThickSpace]\[ThickSpace]\[ThickSpace]\[ThickSpace]\[ThickSpace]"
								],
							"AnchorBar"]
					}},
				ItemSize->{{Scaled[0.35`],{Scaled[0.65`]}}, Automatic},
				Alignment->{{Left,Right},Center}
				],
		"AnchorBarGrid"
		];
iGenerateAnchorBar~SetAttributes~HoldAll


iGenerateTitleCell[sym_]:=
	Cell[
		docSymbolNameToString[sym],
		"ObjectName"
		];
iGenerateTitleCell~SetAttributes~HoldFirst;


generateUsageCell[symbol_String,(def:Except[_Rule])|(None->def_)]:=
	Cell[
		TextData[{
			RefPageRefLink[symbol],
			"\[LineSeparator]",
			Replace[def,{
				RawBoxes[b_]:>b,
				Except[_String]:>ToBoxes@def,
				s_String:>
					Cell[RawBoxes@s,"","InlineFormula"],
				e_:>(Print@e;e)
				}]
			}]
		];
generateUsageCell[symbol_String,pattern_->def_]:=
	Cell[
		TextData[{
			Cell[
				BoxData@
					ReplaceAll[
						holdPatternStrippedBoxes[pattern],{
						s_String?makeRefTest:>
							RefPageRefLink[s,False],
						s_String?symString:>(
							StyleBox[Last@StringSplit[s,"`"],"TI"]
							),
						StyleBox[s_String?italString,o___]:>(
							StyleBox[s,"TI",o]
							)
						}],
				"InlineFormula",
				FormatType->TraditionalForm
				],
						"\[LineSeparator]",
			Replace[def,{
				RawBoxes[b_]:>b,
				Except[_String]:>ToBoxes@def,
				s_String:>
					Cell[RawBoxes@s,"","InlineFormula"]
				}]/.{
					s_String?(StringMatchQ["\"*\""]):>
							StyleBox[s,"Input"],
					StyleBox[s_String?italString,o___]:>(
							StyleBox[s,"TI",o]
							)
					}
			}]
		];
generateUsageCell[symbol_Symbol,e_]:=
	generateUsageCell[Evaluate@docSymbolNameToString[symbol],e];
generateUsageCell~SetAttributes~HoldFirst;
iGenerateUsage[symbol_,usages_List]:=
	Cell[BoxData@
		GridBox[{"",generateUsageCell[symbol,#]}&/@usages],"Usage"];
iGenerateUsage[symbol_,None]:=
	Nothing;
iGenerateUsage~SetAttributes~HoldFirst;


(*Line/@Join[
	{{{0,6},{RandomChoice@Range[4.5,5,.1],6}}},{
	{#,
		ReplacePart[#,
			1\[Rule]RandomChoice@Range[4.5,5,.1]]}&/@
		Map[{1,6-#}&,Range[5]],
	{#,
		ReplacePart[#,
			1\[Rule]RandomChoice@Range[4.5,5,.1]]}&/@
		Map[{.5,6.5-#}&,Range[5]]
	}];*)


detailsOpenerImage=
	Dynamic@
		Overlay[{
			Overlay[{
				Graphics[{},
					Background->
						If[CurrentValue["MouseOver"],
							RGBColor[0.942,0.978,0.992],
							None
							],
					ImageSize->{720,70},
					AspectRatio->Full
					],
				Graphics[{
						If[CurrentValue["MouseOver"],
							RGBColor[0.528,0.585,0.614],
							Black
							],
						Thin,
						{
							Line[{{0,6},{4.6`,6}}],
							Line[{
								{{1,5},{4.8`,5}},
								{{1,4},{4.8`,4}},
								{{1,3},{4.7`,3}},
								{{1,2},{4.6`,2}},
								{{1,1},{4.9`,1}}
								}],
							Line[{
								{{0.5`,5.5`},{4.9`,5.5`}},
								{{0.5`,4.5`},{4.5`,4.5`}},
								{{0.5`,3.5`},{4.7`,3.5`}},
								{{0.5`,2.5`},{4.6`,2.5`}},
								{{0.5`,1.5`},{4.8`,1.5`}}
								}]
							}
						},
					ImageSize->{170,70},
					AspectRatio->Full]
				},
				Alignment->Left
				],
			If[CurrentValue["MouseOver"],Image[CompressedData["
1:eJzdmc9vE0cUxyNAosfeckGIXnujJy6tVKk9VOLStFVz4AIlRD00VQMSouXQ
/hEIIfXAta0qFTggkBqpCA40CSUJtKX8ik1i4ti7XjuJfyQkw/uud52345nx
7I+A1cM3tuPdnfeZN+/HjN869vXQiV0DAwMn36A/Q0dPvz8+fvTMJ2/Sh8/G
Tn45OjZy/KOxUyOjI+OHju2mf74TaA9JCPG/kdfaTKr9pCOkC6TbpBJJBNoi
FUk3SedIw6TBFGMplZJjnPQ7szmOrpNGXzPHWdLdhPbLukUae8UcB1PMfy9d
JR14BRznTXaU1tbFvLMq/lmqirsLrpjMlcWf8yVf0/R+ZtEV/xZrIl+pC6ex
oXtOjfQp3TMQV5YcP+rsX/AaYrZQ6dhsoykSeIsrLR3P+R3gUDIsrbbE7GI8
+1X6u1gV5brSP7FYenAo19ITdy21/Vx38mWxWG2oWIYy4DioYniwXMuUgStH
8yON55L2peToyks7yRAKeUAa90oKjrNJ1hLi9z7FL+a1QDFcWtsQy6vrtGaa
4rFbt84HhVpTZjmekCNS4xDTvcZ+sLxC8fpCVFpbEXmBws9LxHXvuWd81vQz
R7iNF5zjRgKOb2RfmPLSFMVoe/7IzuZmx94Zdg/e+98F3+Pap7R+TCz/lVZk
nwzH5IjEBeqDiQHz68nzTvZ2cYScgXBt3sAymSvJ+fhyDI79Xb4wrOlCrRXM
72Ysf4QceP/Y0cfdw/Kq7JO9lhxH+H3oNcx+34qul/VtFq0/ePz4n6O+47qT
d2SODy05LvD70C/p8pIf02y9VyQmFUd43fZr+/oFyme6+ZJ6lx8sOW5zDvRA
qmcjt8p283Wvio9O/ATXyPGEuVeNNe9E6sklSw6+j/P7VtWzc24jErN8vXuG
+JBjiAu9sGos1F5m0z1Ljsh65L13JL59X7dt1YnfO+n37fpr/Xh31bkLtYbZ
VEjCoVuzqNMYW/d9XMFHuhyMfMlsqlpybNlwFNc2fH9kxmGoJXOFiD+eWXIU
Oce0Zl2hXwpjOYt15RnqCHIKs+kvS46bnAN7UdWzsZbDnNlV23R5l8W3Jwnf
3dfkRqk/+dWS4xzn0OWQuQKrB5J94asq77ZZN4UncZeb+pySr0T2JN9Zcgxz
DlP/E/ZVPOdymfqrSB9AelrR93DoKZhN71lyDHIOnGtMaZ6PfMgZqlIdUXJI
9Q+vTkNfA2eofkk5dI8lB3TNpqZDTyhOIvWczbOuT5TXFM4ZdM+XavnPOgYN
xyjnQH+jG6e9frdZtmPX3LeH/nhYUvdvEPYEbjOylzockwO6xVlMc+bnL8qZ
jrTvU3GEa8/1/WDe60u+mDAxGDi+4hzYz+BsxjQubM1jPyL1XTyvlf2Yrmvj
gQt1nO1tq6S3E3BAVzkLzpd6jQ3BRuRr+AhrDj3lI9oPoT7ocmsWLAaOA8G9
LA9ne/6WJUuP88QhuXc01ZTXyWJxvtt1Nvp8pemfzfQTi+V5excLnoneB+ca
SW1D7kDc257PmVhi/P7xMcmReZDLcK4Rxz/oP2F/WB9gW1qWmL9H7SNdkVl4
zUTex14UfQv6SewfkKvgO8TWcn1deW9aloS/D35B+kPHE1MTYV7MiiUGR6jP
SZcT2v+TF/QasCFLlgQcofaSPiB9T/qNNEtaJHmkHGmK9AvpW9K7pN1y3syK
JSWHsfexVVKWOXYW0Q8cSViQ9/lvcv3CEYdFZug3DhsWFUM/cphYdAz9yqFi
QUzrGEgX03LssDosBl1MUQf7haXD8BJ6c/TW
"], "Byte", ColorSpace -> "RGB", Interleaving -> True, Magnification -> 0.5],Image[CompressedData["
1:eJztmctL1FEUx4cUbNnOjYht29mqTUFQi6BNU5ELN5omLZpIg6hc1B8hIrRo
WxGULqQgoZzxAer4yPcDZJzxnY6Kb+Z2vsPMdOd67/3d30NnFh34huXv3ns+
93HOubeL1U/9j875fL6G8/SHv+rF9fr6qpd3L9Bf7gcaHtcFamtuBZ7X1tXW
X6kuoH+8nFIhiTH2X4yVkipJLaRe0ir7ZwnSMilIaiJVkIrzwGde9aQfzJl9
J9Xl2P9G0qBD/0ULkQJn7H85cz7/VtZOKjsDhmadE7u7u2xhYYGNjY2xvr4+
FgqFWGdnZ1JdXV1sYGCATU5OsqWlJXZ4eKjqZot0j9r47MqQ4Z1q4NXVVTY4
OJjx2UTBYDDJu7W1peq2+RQ4pAzb29ssHA7b8l+m8fFxdnBw4JrFgkG6lyKR
SHJO3TKk1d3dzdbX12VD+T3gKBc7TSQSbGpqyjP/RS0uLopD/iGVuOQ4EZdO
k0HD0uaCo1G2l6x8wF4bHR1N+hKPx9ne3l4yjm1sbCTbm8aDzc1NcfgahxxZ
OQ5n2uo8TE9Pq84rE/saGRnR9tXb28uOjo74Zr8ccDwTx9bFJZxRzLdoyBfp
b/CzaNFoVMsyMzMjNqmwyZF1LpAfdAw7OzvSebfigK2srGj36P7+Pv95qw2O
UnEs3Z6WrYMdDtj8/Lyy/7m5OfHzIkOOSr4RzqjuPOjMlAOxnP9WPCeC3TTk
aOEboV5SrbnVmTblgK2trSnnS6hd3hpyZE0AaiBZ34itVmaHA2vS09MjHQtz
ydlXQw7+HpesW2V9S3KVKw7YxMSEdCzkXs5+G3JkGV9780KOS/uqEt8WP+u+
hanyLHINZzEnHKo9izyt+71dwXAvkf0O8ZKzuCFHwoQDceysOIaHh3mXIoYc
y3wj3ONkfafzhpf7SpVHhJgSNuQI8o1UcR172crsnnP4KxtLqE8+G3I08Y1w
nzbYs645jo+PlTFFiI2vDTkq+EaqPQuhbvWKIxaLWcaUlF0z5CjmG+FdQ1Wv
C/HQMQfqc1UO7O/vFz8vNOSAvvENVTkdEnKtIw68Mxj2/1HFoOCo4xujvlGN
A6H2dsoxOzur7Bd3Apwbzm7b5IBCpnMGIWaiRjLlwF6y6lNYiw4dg4bjCd8J
alvMj25c+Iq6VeThDfOLe6DqPPBCTOTutiiELjnggNp5H/C+ZDU2BB9R8yHH
IN4hbmK9kB9UsdULFg1HWaptxuCTHT+8kCmLhgPyi3sDc+zlW6JXLBYc0Im3
Ubwv4c6ZTywGHFIW9Inax83aIHbg3Ju+z+lYDDmgO6QTj8l4m8G7hp31QWyD
/+n8AN/cstjggEpIbSJL2pAzEfdxF0XdMjQ0lLw/IFZh7XC2hHopa33dsNjk
SOsh6aeKx6Z1pHzJFQv0gNTq0P8PLFVrpHzINQtURLpBekP6QsJlNErCw/k8
qY/0ifSKdJVUIImbXrG44dDWPqZyyoJzyFnOOZywIO4L/yeXFxx2WCQMecVh
wqJgyDsOHYuGIS85ZCw40xqG9245TlkZFo3lO4MJS4bhL7E9ExQ=
"], "Byte", ColorSpace -> "RGB", Interleaving -> True, Magnification -> 0.5]]
			},
			Alignment -> {-.85, Center}
			];


detailsOpenerCell=
	With[{detailsOpenerImage=detailsOpenerImage},
		Cell[
			BoxData@ToBoxes@
				Button[detailsOpenerImage,
					CurrentValue[EvaluationNotebook[], 
						{TaggingRules, "Openers", "NotesSection"}]=Open,
					Appearance->None
					],
			"NotesThumbnails",
			CellOpen-> 
				FEPrivate`If[FEPrivate`Less[FEPrivate`$VersionNumber,11.1],
					False,
					FEPrivate`Not[
						FEPrivate`Or[
							FEPrivate`SameQ[
								FrontEnd`CurrentValue[
									FrontEnd`EvaluationNotebook[], 
										{TaggingRules, "Openers", "NotesSection"}
										], 
								Open
								],
							FEPrivate`SameQ[
								FrontEnd`CurrentValue[
									FrontEnd`EvaluationNotebook[], 
									{TaggingRules, "Openers", "NotesSection"}
									], 
								True
								]
							]
						]
					]
			]
		];


generateDetailsSection[sec:Except[_List]]:=
	Cell[
		Replace[sec,
			Except[_TextData|_BoxData]:>
				TextData@Replace[sec,Except[_String]:>ToBoxes[sec]]
			],
		"Notes"];
generateDetailsSection[sec:{__List}]:=
	Cell[
		TextData@
			Cell[
				BoxData@
					GridBox@
						Map[
							Prepend[
								Replace[#,{
									s:_String|_BoxData|_TextData:>
										Cell[s,"TableText"],
									c_Cell:>
										c,
									e_:>
										Cell[BoxData@ToBoxes[e],"TableText"]
									},
									1],
								Cell["      ", "TableRowIcon"]
								]&,
							sec]
				],
		ToString[Length@First@sec]<>"ColumnTableMod"];
generateDetailsSection[{note:Except[_List],grid_List}]:=
	Cell[CellGroupData[{
		generateDetailsSection[note],
		generateDetailsSection[grid]
		},Closed]];
iGenerateDetails[details:{__}]:=
	openerCellGroup[
		{
			Cell[TextData@"Details","NotesFrameText"],
			"NotesSection"
			},
		generateDetailsSection/@details,
		detailsOpenerCell
		];
iGenerateDetails[None|{}]:=
	Nothing;


Clear@generateBasicExample;


generateBasicExample[
	expression:Except[_String|_Cell|_BoxData|_TextData|Delimiter]
	]:=
	Cell[
		CellGroupData[{
			Cell[BoxData@
				Replace[Hold[expression],{
					Hold[(Hold|HoldPattern)[e_]]:>ToBoxes@Unevaluated[e],
					Hold[e_]:>ToBoxes@Unevaluated[e]
					}],
				"Input",
				CellLabel->(
					If[!IntegerQ@$DocGenLine,$DocGenLine=1];
					TemplateApply["In[``]:=",$DocGenLine]
					)
				],
			With[{e=
				Replace[Hold[expression],{
					Hold[(Hold|HoldPattern)[e_]]:>e,
					Hold[e_]:>e
					}]
				},
				If[e=!=Null,
					Cell[BoxData@ToBoxes@
						Replace[Hold[expression],{
							Hold[(Hold|HoldPattern)[e_]]:>e,
							Hold[e_]:>e
							}],
						"Output",
						CellLabel->
							(
								If[!IntegerQ@$DocGenLine,$DocGenLine=1];
								TemplateApply["Out[``]:=",$DocGenLine++]
								)
						],
					(
						If[!IntegerQ@$DocGenLine,$DocGenLine=1];
						TemplateApply["Out[``]:=",$DocGenLine++]
						);
					$DocGenLine++;
					Nothing
					]
				]
			},
			Open]];


generateBasicExample[b_BoxData]:=
	Replace[b,{
		BoxData[RowBox@{"Defer","[",d_,"]",Except["]"]...}]:>
			Cell[BoxData[d],"InlineFormula","Input"],
		_:>
			Cell[
				CellGroupData[
					{
						Cell[b,"InlineFormula","Input",
							CellLabel->TemplateApply["In[``]:=",$DocGenLine]],
						Replace[ToExpression@b,{
							Null:>($DocGenLine++;Nothing),
							e_:>
								Cell[BoxData@ToBoxes@e,"Output",
									CellLabel->TemplateApply["Out[``]:=",$DocGenLine++]]
							}]
						},
					Open
					]
				]
		}];


generateBasicExample[b_TextData]:=
	ReplaceAll[
		Cell[
			b/.Cell[e_,"Input",o___]:>Cell[e,"InlineFormula","Input",o],
			"ExampleText"
			],
		r_RowBox:>
			ReplaceAll[r,
				{
					c:Cell[BoxData[_TemplateBox],___]:>
						c,
					s_String?makeRefTest:>
						s,
					s_String?symString:>
						StyleBox[
							Last@StringSplit[s,"`"],
							"TI"
							]
					}
				]
		];


generateBasicExample[c_Cell]:>
	c;
generateBasicExample[s_String]:=
	Cell[s,"ExampleText"];
generateBasicExample[Delimiter]:=
	Cell[
		BoxData@
			InterpretationBox[Cell["\t", "ExampleDelimiter"],$Line = 0; Null],
		 "ExampleDelimiter"
		];
generateBasicExample~SetAttributes~HoldFirst;


iGenerateExamples[sym_,exampleSections:{(_String->_List)...}:{}]:=
	ReplaceAll[{
		"\""<>$HomeDirectory<>"\""->"$HomeDirectory",
		s_String?(StringStartsQ["\""<>$HomeDirectory]):>
			Replace[
				FileNameSplit@FileNameDrop[StringTrim[s,"\""],
					FileNameDepth@$HomeDirectory],
				{p__}:>
					Cell[
						BoxData@
							ToBoxes@Unevaluated@
								FileNameJoin@{
									$HomeDirectory,
									p
									}
						]
				]
		}]@
	Block[{$exampleCounter=0},
		openerCellGroup[{"Examples","PrimaryExamplesSection"},
			Map[
				openerCellGroup[{
						Extract[#,{1,1}],
						"ExampleSection",
						ToString@($exampleCounter++)
						},
					Replace[
						Block[{$splitFlag=True},
							SplitBy[
								Thread@Extract[#,{1,2},Hold],
								Replace[{
									Hold[Cell[_,"ExampleSubsection",___]]:>
										($splitFlag=Not@$splitFlag),
									_:>$splitFlag
									}]
								]
							],{
						{
							Hold[Cell[d_,"ExampleSubsection",ops___]],
							c__
							}:>
								openerCellGroup[{
									d,
									"ExampleSubsection",
									If[IntegerQ@$exampleCounter,
										ToString@$exampleCounter++,
										"0"
										],
									ops
									},
									Replace[{c},{
										Hold[Hold[e_]]:>
											generateBasicExample[e],
										Hold[e_]:>
											generateBasicExample[e]
										},
										1]
									],
						c_:>
							
							Replace[c,{
								Hold[Hold[e_]]:>
									generateBasicExample[e],
								Hold[e_]:>
									generateBasicExample[e]
								},
								1]
						},
						1]
					]&,
				Thread[Hold@exampleSections]
				],
			If[Not@MemberQ[First/@exampleSections,"Options"]&&
				Length@Options[sym]>0,
				openerCellGroup[{
					"Options","ExampleSection",
					ToString@$exampleCounter++
					},
					openerCellGroup@{
						ToString[#],"ExampleSubsection",
						ToString@$exampleCounter++
						}&/@Keys@Options[sym]
					],
				Nothing
				]
			]
		];
iGenerateExamples[sym_,basicExamples:{Except[_Rule],___}]:=
	iGenerateExamples[sym,{"Basic Examples"->basicExamples}];
iGenerateExamples~SetAttributes~HoldAll;


If[!ValueQ@$DocFooter,$DocFooter=Automatic];


generateSeeAlsoSection[seeAlso:{__}]:=
	Cell[
		CellGroupData[{
			Cell["See Also","SeeAlsoSection"],
			Cell[
				TextData@
					Flatten@
						If[Length@#>1,
							Riffle[#,
								{{"\[NonBreakingSpace]",StyleBox["\[MediumSpace]\[FilledVerySmallSquare]\[MediumSpace]", "InlineSeparator"]," "}}
								],
							#]&[
							Cell[BoxData@
				 			 TemplateBox[{
									Cell[TextData@First@#],
									pacletLinkBuild@Last@#},
				 			 	"RefLink",
				 			 	BaseStyle->{"InlineFormula"}],
				 			 "InlineFormula"
				 			 ]&/@
									DeleteCases[
										Replace[
											Replace[Thread[Hold[seeAlso]],
												Hold[h_Hold]:>h,
												1],{
											Hold[s_Symbol]:>
												Function[#->#]@ToString@Unevaluated[s],
											Hold[k_->v_String]:>
												k->"paclet:"<>v
											},
											1],
										_String?(StringMatchQ[Whitespace])
										]
								],
				"SeeAlso"]
			},
		Open]];
generateSeeAlsoSection[{}|None]:=
	Nothing;
generateSeeAlsoSection~SetAttributes~HoldFirst;


generateRelatedGuidesSection[relatedGuides:{__}]:=
	Cell[CellGroupData[Flatten@{
		Cell["Related Guides","MoreAboutSection"],
		Cell[BoxData@
			TemplateBox[{
				Cell[TextData@First@#],
					pacletLinkBuild[Last@#,"guide"]},
				"RefLinkPlain",
				BaseStyle->{"InlineFormula"}],
			"MoreAbout"
			]&/@
			Replace[relatedGuides,
				s_String:>(s->s),
				1]
		},
		Open]];
generateRelatedGuidesSection[{}|None]:=
	Nothing;


generateRelatedGuidesSection[relatedGuides:{__}]:=
	Cell[CellGroupData[Flatten@{
		Cell["Related Guides","MoreAboutSection"],
		Cell[BoxData@
			TemplateBox[{
				Cell[TextData@First@#],
					pacletLinkBuild[Last@#,"guide"]},
				"RefLinkPlain",
				BaseStyle->{"InlineFormula"}],
			"MoreAbout"
			]&/@
			Replace[relatedGuides,
				s_String:>(s->s),
				1]
		},
		Open]];
generateRelatedGuidesSection[{}|None]:=
	Nothing;


generateRelatedTutorialsSection[relatedTutorials:{__}]:=
	Cell[CellGroupData[Flatten@{
		Cell["Related Tutorials","RelatedTutorialsSection"],
		Cell[BoxData@
			TemplateBox[{
				Cell[TextData@First@#],
					pacletLinkBuild[Last@#,"tutorial"]},
				"RefLinkPlain",
				BaseStyle->{"InlineFormula"}],
			"RelatedTutorials"
			]&/@
			Replace[relatedTutorials,
				s_String:>(s->s),
				1]
		},
		Open]];
generateRelatedTutorialsSection[{}|None]:=
	Nothing;


generateRelatedLinksSection[relatedLinks:{__}]:=
	Cell[CellGroupData[Flatten@{
		Cell["Related Links","RelatedLinksSection"],
		Cell[
			TextData@
				Cell[
					BoxData@
						TemplateBox[{First@#, Last@#},
					  	"WebLink",
						  BaseStyle->{"RelatedLinks"}
							]
					],
			"RelatedLinks"
			]&/@
			Replace[relatedLinks,
				s_String:>(s->s),
				1]
		},
		Open]];
generateRelatedLinksSection[{}|None]:=
	Nothing;


iGenerateFooter[seeAlso_,guides_,tutorials_,links_,note_]:=
	Cell[
		CellGroupData[{
			generateSeeAlsoSection@seeAlso,
			generateRelatedGuidesSection@guides,
			generateRelatedTutorialsSection@tutorials,
			generateRelatedLinksSection@links,
			If[note===None,Nothing,Cell[note,"History"]],
			Cell[" ","FooterCell"]
			},
			Open]];
iGenerateFooter~SetAttributes~HoldFirst;


iGenerateMetadata[sym_,ops___]:=
	With[{s=ToString@Unevaluated[sym]},
		DeleteDuplicatesBy[First]@{
			ops,
			"built"->ToString@First@DateObject[],
			"history"->{},
			"context"->Replace[DocLinkBase@s,Nothing->"System"]<>"`",
			"keywords"->{},
			"specialkeywords"->{},
			"tutorialcollectionlinks"->{},
			"index"->True,
			"label"->docSymType@sym,
			"language"->"en",
			"paclet"->"Mathematica",
			"status"->"None",
			"summary"->Replace[sym::usage,Except[_String]->""],
			"tabletags"->{},
			"title"->s,
			"titlemodifier"->"",
			"windowtitle"->s,
			"type"->"Symbol",
			"uri"->StringTrim[pacletLinkBuild[s],"paclet:"]
			}
		];
iGenerateMetadata~SetAttributes~HoldFirst


iGenerateRefPages[symbol_,usages_,details_,examples_,
	seeAlso_,relatedGuides_,relatedTutorials_,relatedLinks_,
	footer_]:=
	Block[{cid=1},
		docGenBlock@
			With[{
				cells=
					{
						iGenerateAnchorBar[symbol,seeAlso,relatedGuides],
						iGenerateTitleCell[symbol],
						iGenerateUsage[symbol,usages],
						iGenerateDetails[details],
						Cell["","PageDelimiter"],
						iGenerateExamples[symbol,examples],
						iGenerateFooter[
							seeAlso,relatedGuides,
							relatedTutorials,relatedLinks,
							footer]
						}
				},
				Notebook[cells//.Cell[e__,l:Except[CellID->_]]:>
					(Cell[e,l,CellID->(cid++)]),
					StyleDefinitions->
						Notebook[{
							Cell[
								StyleData[
									StyleDefinitions->
										FrontEnd`FileName[{"Wolfram"},
											"Reference.nb",CharacterEncoding->"UTF-8"]
									]
								],
							Cell[StyleData["Notebook"],
								DockedCells->
									{
										First@
											FrontEndResource["FEExpressions","HelpViewerToolbar"],
										Cell["",
											CellSize->{1,1},
											CellOpen->False,
											CellFrame->{{0,0},{2,0}},
											CellFrameColor->docTypeColor@docSymType@symbol
											]
										}
								],
							Cell[StyleData["DockedCell"],
								CellFrame->{{0,0},{1,0}},
								CellFrameColor->docTypeColor@docSymType@symbol
								]
							}],
						TaggingRules->{
							"ColorType"->"SymbolColor",
							"ModificationHighlight"->False,
							"LinkTrails"->"",
							"HasOptions"->
								(Not@FreeQ[cells,Cell["Options","ExampleSection"]]),
							"SearchTextTranslated" -> "",
							"Metadata"->
								iGenerateMetadata[symbol],
							"Openers"->
								Replace[
									(First@First@#->Map[Last@First@#->Last@#&,Last@#]&)/@
										Normal[
											DeleteDuplicates/@GroupBy[
												Cases[cells,
													HoldPattern[
														CurrentValue[_,{TaggingRules,"Openers",data__},___]
														]:>
														RuleCondition[
															With[{d={data}},
																d->
																	If[
																		MatchQ[d,
																			{"PrimaryExamplesSection"}|
																			{"ExampleSection","0"}
																			],
																		Open,
																		Closed
																		]
																],
															True
															],
													\[Infinity]
													],
												First]
											],
									(c_->{c_->s_}):>(c->s),
									1
									]
							},
						Saveable->False
						]
					]
		];
iGenerateRefPages~SetAttributes~HoldAll;


Options[RefPageNotebook]={
	"Usage"->Automatic,
	"Details"->Automatic,
	"Examples"->Defer,
	"SeeAlso"->Automatic,
	"RelatedGuides"->{},
	"RelatedTutorials"->{},
	"RelatedLinks"->{},
	"Footer":>
		Replace[$DocFooter,
			Except[_String|_TextData]:>
				"Auto-Generated Documentation"
			]
	};
RefPageNotebook[s_Symbol,ops:OptionsPattern[]]:=
	With[{
		seeAlso=
			Replace[OptionValue@"SeeAlso",
				Automatic:>
					ToExpression[relatedFunctionNames[s],StandardForm,Hold]
				],
		guides=OptionValue@"RelatedGuides",
		tutorials=OptionValue@"RelatedTutorials",
		links=OptionValue@"RelatedLinks",
		details=
			Replace[OptionValue@"Details",
				Automatic:>
					scrapeDetails@AutoGenerateDetails[s]
				],
		examples=
			Replace[OptionValue@"Examples",{
				Automatic:>
					scrapeExamples@AutoGenerateExamples[s],
				Defer:>
					scrapeExamples@AutoGenerateExamples[s,True]
				}],
		usage=
			Replace[OptionValue@"Usage",
				Automatic:>
					scrapeUsages@AutoGenerateUsage[s]
				],
		footer=OptionValue@"Footer"
		},
		iGenerateRefPages[s,usage,details,examples,
			seeAlso,guides,tutorials,links,footer]
		];
RefPageNotebook[s_String,ops:OptionsPattern[]]:=
	With[{ns=Names[s]},
		If[Length@ns===0||Length@ns>1,
			DocContextTemplate@s,
			RefPageNotebook[
				Evaluate@ToExpression[s,StandardForm,Unevaluated],
				ops
				]
			]
		]
RefPageNotebook~SetAttributes~HoldFirst;


inlineRefBox[b_]:=
	Cell[BoxData[
  	FormBox[If[ListQ@b,RowBox@b,b], "InlineRef"]],
	  FormatType->"InlineRef"]


relatedFunctionNames[s_String,c:_String|Automatic:Automatic]:=
	With[{
		wordStart=
			With[{trimmed=StringTrim[s,"$"]},
				Replace[StringPosition[trimmed,_?LowerCaseQ],{
					{{three_?(GreaterThan[2]),_},___}:>
						StringTake[trimmed,three-2],
					{__}:>
						Replace[
							StringPosition[StringDrop[trimmed,1],
								_?(Not@*LowerCaseQ)],{
							{{two_,_},___}:>
								StringTake[trimmed,two],
							_:>StringTake[trimmed,3]
							}],
					_:>StringTake[trimmed,3]
					}]
				],
		cont=
			Replace[c,
				Automatic:>
					ToExpression[s,StandardForm,Context]
				]
		},
		Select[
			StringTrim[Names[cont<>"*"],cont],
			#!=s&&
			StringMatchQ[StringTrim[#,"$"],
				wordStart~~(""|(_?(Not@*LowerCaseQ)~~___))]&
			]
		];
relatedFunctionNames[s_Symbol,c:_String|Automatic:Automatic]:=
	relatedFunctionNames[Evaluate@ToString@Unevaluated[s],
		Replace[c,
			Automatic:>Context[s]
			]];
relatedFunctionNames~SetAttributes~HoldFirst


novelFunctionOptions[sym_,
	others_:{
		Graphics,Graphics3D,
		Framed,Style,Cell,
		CloudDeploy,Button,
		Pane,Panel,ActionMenu,
		PopupMenu,Column,
		Row,Grid,CreateDocument,
		Notebook,Plot,Plot3D
		}
	]:=
	With[{
		o=Options@sym,
		tests=
			Replace[First/@Options@#,
				s_Symbol:>
					SymbolName@s,
				1]&/@others},
		With[{selected=
			Flatten@
				Select[tests,
					With[{k=
						Replace[Keys@o,
							s_Symbol:>
								SymbolName@s,
							1]},
							Complement[#,k]=={}&
						]
					]
			},
			DeleteCases[o,
				_[_?(MemberQ[selected,Replace[#,_Symbol:>SymbolName[#]]]&),_]
			]
		]
	];
novelFunctionOptions[s:Except[_Symbol]?(MatchQ[#,_Symbol]&)]:=
	novelFunctionOptions@Evaluate@s;
novelFunctionOptions~SetAttributes~HoldFirst


containedFunctionOptions[sym_,
	others_:{
		Graphics,Graphics3D,
		Framed,Style,Cell,
		CloudDeploy,Button,
		Pane,Panel,ActionMenu,
		PopupMenu,Column,
		Row,Grid,CreateDocument,
		Notebook
		}
	]:=
	With[{
		o=Options@sym},
		Select[others,
			With[{k=
				Replace[Keys@o,
					s_Symbol:>
						SymbolName@s,
					1]},
					With[{ops=
						Replace[First/@Options@#,
							s_Symbol:>
								SymbolName@s,
							1]
						},
						Complement[ops,k]=={}
						]&
				]
			]
		];
containedFunctionOptions[s:Except[_Symbol]?(MatchQ[#,_Symbol]&)]:=
	containedFunctionOptions@Evaluate@s;
containedFunctionOptions~SetAttributes~HoldFirst


usagePatternReplace[vals_,
	reps_:{}
	]:=
	With[{
		names=AssociationMap[Null&,{}(*Names[]*)],
		conts=Alternatives@@{"System`","FrontEnd`","PacletManager`"}
		},
		ReplaceRepeated[vals,
			Flatten@{
				reps,
				Verbatim[Optional][name_,_]:>
					name,
				Verbatim[Pattern][name_,_]:>
					name,
				Verbatim[PatternTest][p_,_]:>
					p,
				Verbatim[Alternatives][a_,___]:>
					a,
				symbolUsageReplacementPattern[names,conts]
				}
			]
		]


symbolUsageReplacementPattern[names_,conts_]:=
	s_Symbol?(
		Function[Null,
			!MatchQ[Context[#],conts]&&
			!MemberQ[$ContextPath,Context[#]]&&
				!KeyMemberQ[names,SymbolName@Unevaluated[#]],
			HoldFirst]
		):>
		RuleCondition[
			ToExpression@
				System`Evaluate[$Context<>
					With[{name=SymbolName@Unevaluated[s]},
						If[StringLength@StringTrim[name,"$"]>0,
							StringTrim[name,"$"],
							name
							]
						]
					],
			True]


toSafeBoxes[e_,___]:=
	FrontEndExecute[
		FrontEnd`UndocumentedTestFEParserPacket[
			ToString[Unevaluated@e,InputForm],
			True]
		][[1,1]];
toSafeBoxes~SetAttributes~HoldFirst;


AutoGenerateUsage[sym_Symbol]:=
	With[{
		vals=
			Replace[
				usagePatternReplace[
					Join@@
						Through[
							{UpValues,DownValues,SubValues}@
								Unevaluated[sym]
							]
					],{
				l:{__}:>
					Map[
						Cell[
							Replace[First@#,{
								None:>
									BoxData@ToString@Unevaluated@sym,
								Verbatim[HoldPattern][Verbatim[HoldPattern][e_]]:>
									Replace[
										FixedPoint[
											Replace[
												Verbatim[HoldPattern][Verbatim[HoldPattern][p_]]:>
													HoldPattern[p]
												],
											HoldPattern[e]
											],
										Verbatim[HoldPattern][e2_]:>
											BoxData@toSafeBoxes[Unevaluated[e2],StandardForm]
										],
								Verbatim[HoldPattern][e_]:>
									BoxData@toSafeBoxes[Unevaluated[e],StandardForm]
								}],
							"UsageInput"
							]&,
						l
						],
				{}->{
						Cell[BoxData@toSafeBoxes[Unevaluated[sym],StandardForm],
							"UsageInput"]
						}
				}]
			},
			With[{s=
				StringSplit[
					StringTrim@
						Replace[sym::usages,
							_MessageName:>
							Replace[sym::usage,
								_MessageName:>"No usage message..."]
							],
					"\n"
					]
				},
				If[Length@s>=Length@vals,
					With[{u=Flatten@ConstantArray[vals,Length@s]~Take~Length@s},
						Riffle[u,Cell[#,"UsageText"]&/@s]
						],
					Append[
						Riffle[vals,
							Cell[StringTrim@StringJoin@Riffle[s,"\n"],"UsageText"]
							],
						Cell[StringTrim@StringJoin@Riffle[s,"\n"],"UsageText"]
						]
					]
				]
		];
AutoGenerateUsage[s:Except[_Symbol]?(MatchQ[#,_Symbol]&)]:=
	AutoGenerateUsage@System`Evaluate@s;
AutoGenerateUsage~SetAttributes~HoldFirst;


callPatternReplace[vals_,
	reps_:{}
	]:=
	DeleteCases[
		ReplaceRepeated[
			vals,
			Flatten@
				{
					reps,
					Verbatim[Blank][t_]:>
						RuleCondition[
							Replace[t,{
								Integer->1,
								String->"String",
								List->{},
								Association-><||>
								}],
							True],
					Verbatim[BlankSequence][t_]:>
						RuleCondition[
							Replace[t,{
								Integer->Sequence[0,1],
								String->Sequence["a","b"],
								List->Sequence[{},{}],
								Association->Sequence[<||>,<||>],
								_:>Sequence[t,t]
								}],
							True],
					Verbatim[BlankNullSequence][t_]:>
						Sequence[],(*
					Verbatim[Pattern][name_,Verbatim[Blank][]]:>
						name,*)
					Verbatim[Repeated][t_,___]:>
						t,
					Verbatim[RepeatedNull][___]:>
						Sequence[],
					Verbatim[Pattern][_,p_]:>
						Unevaluated@p,
					Verbatim[PatternTest][p_,_]:>
						Unevaluated@p,
					Verbatim[Alternatives][a_,___]:>
						a,
					Verbatim[Optional][_,v_]:>
						Unevaluated@v,
					Verbatim[Blank][t_]:>t[],
					Verbatim[Blank][]:>Null,
					Verbatim[BlankSequence][]:>Sequence[Null,Null],
					(Verbatim[BlankNullSequence]|Verbatim[OptionsPattern])[]:>
						Sequence[],
					h_[a___,Verbatim[Sequence][e__],b___]:>
						h[a,e,b]
					}
			],
		Verbatim[Sequence][],
		\[Infinity]
		];


AutoGenerateExamples[sym_,defer:True|False:False]:=
	With[
		{
		vals=
			(*With[{names=AssociationMap[Null&,Names["System`"|"FrontEnd`"]]},
				(*ReplaceAll[*)*)
			Map[First,
				Join@@
					Through[{UpValues,DownValues,SubValues}@Unevaluated[sym]]
				]
				(*]*)},
		Flatten@{
			With[{c=Context[sym]},
				If[MemberQ[$ContextPath,c]&&Not@MatchQ[c,"Global`"|"System`"],
					{
						Cell["Load "<>StringTrim[c,"`"]<>":","ExampleText"],
						Cell[BoxData@
								If[defer,
									RowBox@{"Defer","[",#,"]"},
									#
									]&@RowBox@{"Needs","[","\""<>c<>"\"","]"},
							"ExamplesInput"],
						Cell["\t","ExampleDelimiter"]
						},
					Nothing
					]
				],
			Flatten@Riffle[Partition[#,2],
				Cell["\t","ExampleDelimiter"]
				]&@
			Riffle[
				Cell[TextData@{"From ",
					inlineRefBox@Replace[usagePatternReplace@#,
							Verbatim[HoldPattern][e_]:>{
								toSafeBoxes[Unevaluated[e],StandardForm]
							}],":"},
					"ExampleText"
					]&/@vals,
				Cell[
					BoxData@
						If[defer,
							Replace[#,{
								Verbatim[HoldPattern][e_]:>
									RowBox@{"Defer","[",
										toSafeBoxes[Unevaluated@e,StandardForm],
										"]"}
								}],
							Replace[#,{
								Verbatim[HoldPattern][e_]:>
									toSafeBoxes[Unevaluated@e,StandardForm]
								}]
							],
					"ExamplesInput"
					]&/@callPatternReplace[vals]
					],
			AutoGenerateOptionExamples[sym,defer]
			}
		];
AutoGenerateExamples[
	e:Except[_Symbol]?(MatchQ[#,_Symbol]&),
	defer:True|False:False]:=
	AutoGenerateExamples[System`Evaluate@e,defer];
AutoGenerateExamples~SetAttributes~HoldFirst


AutoGenerateOptionExamples//Clear;
AutoGenerateOptionExamples[sym_Symbol,defer:True|False:False]:=
	With[{
		u=
			FirstCase[First/@DownValues[sym],
				Verbatim[HoldPattern][
					_[
						___,
						Verbatim[OptionsPattern][]|
						Verbatim[Pattern][_,Verbatim[OptionsPattern][]],
						___
						]
					],
				HoldPattern[sym[OptionsPattern[]]]
				],
		ops=If[Length@OwnValues[sym]==0,novelFunctionOptions[sym],{}]
		},
		With[{usages=
			Map[
				First@#->
					callPatternReplace[u,
						Verbatim[OptionsPattern][]->#
						]&,
				ops
				]
			},
			If[Length@usages>0,
				Cell[CellGroupData[Flatten@{
					Cell["Options","ExampleSection"],
					Map[
						Cell@
							CellGroupData[{
								Cell[ToString@First@#,"ExampleSubsection"],
								Cell[BoxData@
									Replace[Last@#,{
										Verbatim[HoldPattern][e_]:>
											If[defer,
												RowBox@{"Defer","[",
													toSafeBoxes[Unevaluated[e],StandardForm],
													"]"},
												toSafeBoxes[Unevaluated[e],StandardForm]
												]
										}],
									"ExamplesInput"]
								},
								Closed]&,
						usages
						]
					},Closed]
					],
				Nothing
				]
			]
		];
AutoGenerateOptionExamples[e:Except[_Symbol]?(MatchQ[#,_Symbol]&),
	defer:True|False:False]:=
	AutoGenerateOptionExamples[System`Evaluate@e,defer];
AutoGenerateOptionExamples~SetAttributes~HoldFirst


AutoGenerateDetails[sym_Symbol]:=
	With[{
		ovs=OwnValues[sym],
		dvs=DownValues[sym],
		uvs=UpValues[sym],
		svs=SubValues[sym],
		fvs=FormatValues[sym],
		hovs=System`Private`HasOwnCodeQ[sym],
		hdvs=System`Private`HasDownCodeQ[sym],
		huvs=System`Private`HasUpCodeQ[sym],
		hsvs=System`Private`HasSubCodeQ[sym],
		hfvs=System`Private`HasSubCodeQ[sym],
		ops=If[Length@OwnValues[sym]==0,novelFunctionOptions[sym],{}],
		conts=If[Length@OwnValues[sym]==0,containedFunctionOptions[sym],{}],
		attrs=Flatten@{Attributes[sym]},
		msgs=
			DeleteCases[Messages[sym],
				Verbatim[HoldPattern][
					HoldPattern@MessageName[_,"usage"|"usages"]
					]:>_
				]
		},
		Flatten@{
			Replace[Length@ovs,{
				0->Nothing,
				1->
					Cell[TextData@{
						inlineRefBox@toSafeBoxes[Unevaluated@sym,StandardForm],
						" has an immediate value"
						},"DetailsItem"],
				n_:>
					Cell[TextData@{
						inlineRefBox@toSafeBoxes[Unevaluated@sym,StandardForm],
						" has ",
						ToString@n,
						" immediate values"
						},"DetailsItem"]
				}],
			If[hovs,
				Cell[TextData@{
					inlineRefBox@toSafeBoxes[Unevaluated@sym,StandardForm],
					" has an internal immediate value"
					},
					"DetailsItem"
					],
				Nothing
				],
			If[Length@dvs>0,
				Cell[TextData@{
					inlineRefBox@toSafeBoxes[Unevaluated@sym,StandardForm],
					" has ",
					ToString@Length@dvs,
					" call",
					If[Length@dvs>1," patterns"," pattern"]
					},"DetailsItem"],
				Nothing
				],
			If[hdvs,
				Cell[TextData@{
					inlineRefBox@toSafeBoxes[Unevaluated@sym,StandardForm],
					" has an internal call pattern"
					},
					"DetailsItem"
					],
				Nothing
				],
			If[Length@uvs>0,
				Cell[TextData@{
					inlineRefBox@toSafeBoxes[Unevaluated@sym,StandardForm],
					" has ",
					ToString@Length@uvs,
					" ",
					inlineRefBox@"UpValues",
					If[Length@uvs>1," patterns"," pattern"]
					},"DetailsItem"],
				Nothing
				],
			If[hdvs,
				Cell[TextData@{
					inlineRefBox@toSafeBoxes[Unevaluated@sym,StandardForm],
					" has an internal ",
					inlineRefBox@"UpValues",
					" pattern"
					},
					"DetailsItem"
					],
				Nothing
				],
			If[Length@svs>0,
				Cell[TextData@{
					inlineRefBox@toSafeBoxes[Unevaluated@sym,StandardForm],
					" has ",
					ToString@Length@svs,
					" ",
					inlineRefBox@"SubValues",
					If[Length@svs>1," patterns"," pattern"]
					},"DetailsItem"],
				Nothing
				],
			If[hsvs,
				Cell[TextData@{
					inlineRefBox@toSafeBoxes[Unevaluated@sym,StandardForm],
					" has an internal ",
					inlineRefBox@"SubValues",
					" pattern"
					},
					"DetailsItem"
					],
				Nothing
				],
			If[Length@ops>0,
				{
					Cell[TextData@{
						inlineRefBox@toSafeBoxes[Unevaluated@sym,StandardForm],
						" has the following ",
						inlineRefBox@"Options"
						},"DetailsItem"],
					Map[
						{
							Cell[TextData@inlineRefBox@
								toSafeBoxes[Evaluate@First@#,StandardForm],
								"DetailsRow"],
							Cell[TextData@inlineRefBox@
								Extract[#,2,toSafeBoxes],
								"DetailsColumn"]
							}&,
						ops
						]
					},
				Nothing
				],
			If[Length@conts>0,
				{
					Cell[TextData@{
						inlineRefBox@toSafeBoxes[Unevaluated@sym,StandardForm],
						" can take any ",inlineRefBox@"Options",
						" from the following"
						},"DetailsItem"],
					Map[
						{
							Cell[TextData@inlineRefBox@ToBoxes[#,StandardForm],
								"DetailsRow"]
							}&,
						conts
						]
					},
				Nothing
				],
			If[Length@msgs>0,
				{
					Cell[TextData@{
						inlineRefBox@toSafeBoxes[Unevaluated@sym,StandardForm],
						" has the following ",
						inlineRefBox@"Messages"
						},"DetailsItem"],
					Map[
						{
							Cell[TextData@inlineRefBox@
									Replace[First@#,
										Verbatim[HoldPattern][m_MessageName]:>
											ToBoxes[Unevaluated[m]]
										],
								"DetailsRow"],
								Cell[TextData@inlineRefBox@ToBoxes[Last@#,StandardForm],
								"DetailsColumn"]
							}&,
						msgs
						]
					},
				Nothing
				],
			If[Length@attrs>0,
				{
					Cell[TextData@{
						inlineRefBox@toSafeBoxes[Unevaluated@sym,StandardForm],
						" has the following ",
						inlineRefBox@"Attributes"
						},"DetailsItem"],
					Map[
						Cell[TextData@inlineRefBox@ToBoxes[#,StandardForm],
							"DetailsRow"]&,
						attrs
						]
					},
				Nothing
				],
			If[Length@fvs>0||hfvs,
				Cell[TextData@{
					inlineRefBox@toSafeBoxes[Unevaluated@sym,StandardForm],
					" is a formatted symbol"
					}],
				Nothing
				]
			}
		];
AutoGenerateDetails[s:Except[_Symbol]?(MatchQ[#,_Symbol]&)]:=
	AutoGenerateDetails@System`Evaluate@s;
AutoGenerateDetails~SetAttributes~HoldFirst;


RefPageGenButton=
	Button["Generate Ref Pages",
		With[{c=$Context},
			SelectionMove[EvaluationCell[],All,CellGroup,
				AutoScroll->False];
			GenerateRefPages@InputNotebook[];
			If[$Context=!=c,End[]];
			SelectionMove[EvaluationCell[],After,Cell];
			],
		Method->"Queued"
		];


Options[RefPageTemplate]={
	"Headers"->{},
	"Footers"->{},
	"Usage"->Automatic,
	"Details"->Automatic,
	"Examples"->Automatic,
	"Functions"->Automatic,
	"RelatedGuides"->Automatic,
	"RelatedTutorials"->Automatic,
	"RelatedLinks"->Automatic
	};
Options[refPageTemplate]=Options[RefPageTemplate];
refPageTemplate[s_String,OptionsPattern[]]:=
	Cell[CellGroupData[
		Flatten@{
			Cell[s,"DocSection"],
			Replace[OptionValue@"Usage",{
				Automatic:>
					ToExpression[s,StandardForm,AutoGenerateUsage],
				Default->{
					Cell[BoxData@s,"UsageInput"],
					Cell[
						Replace[
							MessageName@@{
								ToExpression[s,StandardForm,Unevaluated],
								"usage"},
							Except[_String]:>"Description"],
						"UsageText"]
					},
				Except[_List|_Cell]->
					Nothing
				}],
			Replace[OptionValue@"Details",{
				Automatic:>
					Cell[CellGroupData[Flatten@{
						Cell["Details","DetailsSection"],
						ToExpression[s,StandardForm,AutoGenerateDetails]
						},
						Closed]
						],
				Default->{
					Cell["Details","DetailsSection"],
					Cell["Function Details","DetailsItem"]
					},
				Except[_List|_Cell]->
					Nothing
				}],
			Replace[OptionValue@"Examples",{
				Automatic:>{
					Cell["Basic Examples","ExampleSection"],
					Replace[
						ToExpression[s,StandardForm,AutoGenerateExamples],
						c:{}|{
							Cell[_String?(StringMatchQ["Load *:"]),"ExampleText"],
							_Cell,
							_Cell
							}:>
							Append[c,
								Cell[BoxData@s,"ExamplesInput"]
								]
						]
					},
				Defer:>{
					Cell["Basic Examples","ExampleSection"],
					Replace[ToExpression[s,StandardForm,
						Function[Null,AutoGenerateExamples[#,True],HoldFirst]],
						c:{}|{
							Cell[_String?(StringMatchQ["Load *:"]),"ExampleText"],
							_Cell,
							_Cell
							}:>
							Append[c,
								Cell[BoxData@RowBox@{"Defer","[",s,"]"},"ExamplesInput"]
								]
						]
					},
				Default->{
					Cell["Basic Examples","ExampleSection"],
					Cell[BoxData@s,"ExamplesInput"],
					With[{ops=
						With[{sym=ToExpression[s,StandardForm,Unevaluated]},
							If[Length@OwnValues@sym===0,
								Options@sym,
								{}
								]
							]},
						If[Length@ops>0,
							Cell[CellGroupData[Flatten@{
								Cell["Options","ExampleSection"],
								Map[
									Cell@
										CellGroupData[{
											Cell[ToString@First@#,"ExampleSubsection"],
											Cell[BoxData@toSafeBoxes[#,StandardForm],
												"ExamplesInput"]
											},
											Closed]&,
									ops
									]
								},Closed]
								],
							Nothing
							]
						]
					},
				Except[_List|_Cell]->
					Nothing
				}],
			Replace[OptionValue@"Functions",{
				Automatic:>
					{
						Cell["See Also","SeeAlsoSection"],
						Cell[#,"SeeAlso"]&/@relatedFunctionNames[s]
						},
				Default->{
					Cell["See Also","SeeAlsoSection"],
					Cell["RelatedFunction","SeeAlso"],
					Cell["\"Name\" -> ref/path/thing","SeeAlso"]
					},
				fs:{__String}:>
					{
						Cell["See Also","SeeAlsoSection"],
						Cell[#,"SeeAlso"]&/@fs
						},
				e:Except[_List|_Cell]:>{}
				}],
			Replace[OptionValue@"RelatedGuides",{
				Automatic->{
					Cell["Related Guide","GuidesSection"],
					Cell["Related Guide Title | RelatedGuide",
						"RelatedGuide"]
					},
				l:{(_String|_Rule)..}:>
					{
						Cell["Related Guide","GuidesSection"],
						Map[
							Cell[
								First@#<>" | "<>
									StringReplace[Last@#,Except[WordCharacter]->""],
								"RelatedGuide"]&,
							Replace[l,
								t_String:>(t->t),
								1]
							]
						},
				Except[_List|_Cell]->{}
				}],
			Replace[OptionValue@"RelatedTutorials",{
				Automatic->{
					Cell["Related Tutorials","TutorialSection"],
					Cell["Related Tutorial Title | RelatedTutorial",
						"RelatedTutorial"]
					},
				l:{(_String|_Rule)..}:>
					{
						Cell["Related Tutorials","TutorialSection"],
						Map[
							Cell[
								First@#<>" | "<>
									StringReplace[Last@#,Except[WordCharacter]->""],
								"RelatedTutorial"]&,
							Replace[l,
								t_String:>(t->t),
								1]
							]
						},
				Except[_List|_Cell]->{}
				}],
			Replace[OptionValue@"RelatedLinks",{
				Automatic->{
					Cell["Related Links","LinksSection"],
					Cell["Related Link Title | RelatedLink","RelatedLink"]
					},
				l:{(_String|_Rule)..}:>
					{
						Cell["Related Tutorials","LinksSection"],
						Map[
							Cell[
								First@#<>" | "<>
									StringReplace[Last@#,Except[WordCharacter]->""],
								"RelatedTutorial"]&,
							Replace[l,
								t_String:>(
									URLBuild[
										ReplacePart[
											URLParse[t],{
											"Scheme"->None,
											"Query"->{}
											}]
										]->t),
								1]
							]
						},
				Except[_List|_Cell]->{}
				}],
			Cell["","SectionSeparator"]
			},
		Closed]
		];
RefPageTemplate[s:{__String},ops:OptionsPattern[]]:=
	Notebook[
		Flatten@{
			OptionValue@"Headers",
			refPageTemplate[#,ops]&/@s,
			OptionValue@"Footers"
			},
		StyleDefinitions->
			With[{p=`Package`$PackageName},
				FrontEnd`FileName[{p},"DocGen.nb"]
				]
		];
RefPageTemplate[s_String,ops:OptionsPattern[]]:=
	Replace[RefPageTemplate[{s},ops],
		Cell[CellGroupData[d_,Closed]]:>
			Cell[CellGroupData[d]],
		2];
RefPageTemplate[s_Symbol,ops:OptionsPattern[]]:=
	RefPageTemplate[ToString@s,ops];


Options[RefPageContextTemplate]=
	Options@RefPageTemplate
RefPageContextTemplate[s_String,ops:OptionsPattern[]]:=
	RefPageTemplate[Names[s<>"*"],
		FilterRules[{
			ops,
			"Headers"->{Cell[s,"ContextSection"]}
			},
			Options@RefPageTemplate
			]
		];


scrapeUsages[usages_]:=
	SequenceCases[usages,
		{Cell[e_,___,"UsageInput",___],Cell[t_,___,"UsageText",___]}:>
			RawBoxes@First@e->
				Replace[parseRefText[t],{
					td_TextData:>
						RawBoxes@Cell[td,"InlineFormula"]
					}]
		]


scrapeDetails[details_]:=
	With[{baseData=
		Replace[#,
			{
				Cell[bd_,"DetailsItem",___]:>
					bd,
				Cell[bd_,"DetailsRow",___]:>
					"Row"->bd,
				Cell[bd_,"DetailsColumn",___]:>
					"Col"->bd
				},
			1]&@
		Replace[parseRefText[details],
			{
				td_TextData:>
					RawBoxes@Cell[td,"InlineFormula"]
				}]
		},
			Replace[SplitBy[baseData,Head],{
				r:{__Rule}:>
					Map[Last]/@SequenceCases[r,{"Row"->_,("Col"->_)...}],
				items:{__}:>
					Sequence@@items
				},
				1]
		];


scrapeExamples[examples_]:=
	Replace[
		DeleteCases[{"- BreakPoint -"}]@
		SplitBy[
			Replace[NotebookTools`FlattenCellGroups@examples,{
				Cell[n_,"ExampleSection",___]:>
					Sequence@@{"- BreakPoint -",n->n},
				Cell[t_,"ExampleText",___]:>
					parseRefText[t],
				Cell["Delimiter"|"----"|""|BoxData["Delimiter"],___]|
					Cell[_,"ExampleDelimiter",___]:>
					Delimiter,
				Cell[e_,"ExamplesInput",___]:>
					e
				},1],
			MatchQ["- BreakPoint -"]
			],{
		{n_->_,e__}:>
			n->{e},
		e:{__}:>
			"Basic Examples"->e
		},
		1]


scrapeRefPageChunk[c:{__Cell}]:=
	docGenBlock@
		With[{
			sym=FirstCase[c,Cell[s_,___,"DocSection",___]:>s],
			usages=Cases[c,Cell[__,"UsageInput"|"UsageText",___]],
			details=
				Cases[c,
					Cell[__,
						"DetailsItem"|"DetailsRow"|"DetailsColumn",
						___]
					],
			examples=Cases[c,Cell[__,
				"ExampleSection"|"ExampleSubsection"|
				"ExampleText"|"ExamplesInput"|"ExampleDelimiter",
				___]],
			guides=
				Cases[c,Cell[__,"RelatedGuide",___]],
			tutorials=
				Cases[c,Cell[__,"RelatedTutorial",___]],
			links=
				Cases[c,Cell[__,"RelatedLink",___]],
			seeAlso=Cases[c,Cell[__,"SeeAlso",___]]
			},
			{
				"Symbol"->sym,
				"Usage"->
					scrapeUsages@usages,
				"Details"->
					scrapeDetails@details,
				"Examples"->
					scrapeExamples@examples,
				"RelatedGuides"->
					Replace[First/@guides,{
						s_String:>
							Replace[StringSplit[s," | "],{
								{str_}:>
									str->str,
								{l_,g_}:>
									l->g
								}],
						_->Nothing
						},
						1],
				"RelatedTutorials"->
					Replace[First/@tutorials,{
						s_String:>
							Replace[StringSplit[s," | "],{
								{str_}:>
									str->str,
								{l_,g_}:>
									l->g
								}],
						_->Nothing
						},
						1],
				"RelatedLinks"->
					Replace[First/@links,{
						s_String:>
							Replace[StringSplit[s," | "],{
								{str_}:>
									str->str,
								{l_,g_}:>
									l->g
								}],
						_->Nothing
						},
						1],
				"SeeAlso"->
					Replace[First/@seeAlso,{
						s_String?(StringMatchQ["* -> *"]):>
							Rule@@StringSplit[s," -> "],
						s_String?symString:>
							ToExpression[s,StandardForm,Hold],
						_->Nothing
						},
						1],
				"Footer"->
					Replace[$DocFooter,
						Except[_String|_TextData]:>
							("Generated on  "<>DateString[])
						],
				WindowTitle->Last@StringSplit[sym,"`"]
				}
			];
scrapeRefPageTemplate[c:{__Cell}]:=
	With[{cells=NotebookTools`FlattenCellGroups@c},
		scrapeRefPageChunk@cells[[#]]&/@
			Replace[
				Flatten@Position[cells,Cell[__,"DocSection",___]],{
					i:{__}:>
						Span@@@Partition[Riffle[i,Append[Rest@i-1,-1]],2]
				}]
		]


scrapeRefPageTemplate[cells:{__CellObject}]:=
	scrapeRefPageTemplate[NotebookRead/@cells];
scrapeRefPageTemplate[nb_NotebookObject]:=
	scrapeRefPageTemplate@
		Replace[NotebookRead@nb,{
			c_Cell:>
				{c},
			c:{__Cell}:>
				c,
			_:>
				Cells@nb
			}];


Options[GenerateRefPages]=
	Join[
		Options[RefPageNotebook],
		Options[CreateDocument]
		];
GenerateRefPages[s_Symbol,ops:OptionsPattern[]]:=
	Block[{
		$Context=$docGen,
		$ContextPath=Join[$ContextPath,{Context@s,$Context}],
		makeRefOverrides=
			Join[
				makeRefOverrides,{
				ToString@Unevaluated@s,
				SymbolName@Unevaluated@s
				}]
		},
		CheckAbort[
			$DocGenLine=1;
			CreateDocument[
				RefPageNotebook[s,
					FilterRules[{ops},Options@RefPageNotebook]
					],
				FilterRules[{ops},Options@CreateDocument],
				WindowTitle->(
					Last@
						StringSplit[
							ToString@Unevaluated[s],
							"`"
							]<>" - Documentation"),
				System`ClosingSaveDialog->False
				],
			If[$Context==$docGen,End[]]
			]
		];
GenerateRefPages[namePattern_String,ops:OptionsPattern[]]:=
	Block[{
		$DocActive=
			If[StringMatchQ[namePattern,"*`"],
				StringTrim[namePattern,"`"],
				$DocActive
				],
		makeRefOverrides=
			Names[namePattern<>"*"]
		},
		ToExpression[Names[namePattern<>"*"],StandardForm,
			Function[Null,GenerateRefPages[#,ops],HoldFirst]
			]
		];
GenerateRefPages~SetAttributes~HoldFirst;


GenerateRefPages[nb_NotebookObject]:=
	With[{
		sym=ToExpression[Lookup[#,"Symbol"],StandardForm,Unevaluated],
		ops=DeleteCases[#,"Symbol"->_]},
		Block[{$DocGenLine=0},
			GenerateRefPages[sym,ops]
			]
		]&/@scrapeRefPageTemplate@nb;
GenerateRefPages[
	nb:EvaluationNotebook[]|InputNotebook[]|_CreateDocument:
		EvaluationNotebook[]]:=
	GenerateRefPages[Evaluate@nb];


Options[SaveRefPages]=
	Options[GenerateRefPages];
SaveRefPages[
	doc:_String|_Symbol|{__String},
	dir_String?DirectoryQ,
	extension:True|False:True,
	ops:OptionsPattern[]
	]:=
	Replace[
		GenerateRefPages[doc,
			Visible->False,
			ops],{
		nb:_NotebookObject|{__NotebookObject}:>(
			Quiet@CreateDirectory[
				FileNameJoin@{
					dir,
					If[extension,
						Sequence@@{
							"ReferencePages",
							"Symbols"
							},
						Nothing
						]
					},
				CreateIntermediateDirectories->True
				];
			Map[
				Replace[
					CurrentValue[
						#,
						{TaggingRules,"Metadata","uri"}
						],
					s_String:>
						{
							Export[
								FileNameJoin@{
									dir,
									If[extension,
										Sequence@@{
											"ReferencePages",
											"Symbols"
											},
										Nothing
										],
									Last@URLParse[s,"Path"]<>".nb"
									},
								DeleteCases[NotebookGet@#,Visible->_]
								]
							}
					]&,
				Flatten@{nb}
			]
			),
		_->$Failed
		}];
SaveRefPages[
	doc_?(MatchQ[#,String|_Symbol|{__String}]&),
	dir_String?DirectoryQ,
	extension:True|False:True,
	ops:OptionsPattern[]
	]:=
	SaveRefPages[Evaluate@doc,dir,extension,ops]
SaveRefPages~SetAttributes~HoldFirst


(* ::Subsection:: *)
(*Guides*)



guideRefBox[name_String->f_String,styling_:"InlineFunctionSans"]:=
	Cell[
		BoxData@
			TemplateBox[{
				Cell[TextData[Last@StringSplit[name,"`"]]],
						Which[
							StringMatchQ[f,"\"*"],
								pacletLinkBuild[{"format",f}],
							StringMatchQ[f,"paclet:*"],
								f,
							True,
								pacletLinkBuild@f
							]
					},
		   "RefLink",
		   BaseStyle->styling]
		];
guideGuideRefBox[n_,g_]:=
	TemplateBox[{
		Cell[Replace[n,{None->"...",_:>TextData[n<>" \[RightGuillemet]"]}]],
			pacletLinkBuild[g,"guide"]},
	 	 "OrangeLink",
		  BaseStyle->"GuideFunctionsSubsection"
		];
guideRefBox[s_String,styling_:"InlineFunctionSans"]:=
	guideRefBox[s->s,styling];


guideSubsection[
	name:(_String->_String)|_String|None,
	fs_]:=
	Cell@
		CellGroupData[Flatten@{
			Replace[name,{
				None->Nothing,
				e_:>
					guideSubsectionHead@e
				}],
			guideFunctionCell[#,name]&/@fs
			}];
guideSubsection[name_->fs_]:=
	guideSubsection[name,fs];
guideSubsectionHead[name_]:=
	Cell[
		Replace[name,{
			(n_->g_):>
				 BoxData@guideGuideRefBox[n,g]
			}],
		"GuideFunctionsSubsection"
		];
guideFunctionCell[functions:{__String},name_:None]:=
	Cell[TextData[Flatten@{
		If[Length@#>1,
			Riffle[#,
				{{"\[NonBreakingSpace]",StyleBox["\[MediumSpace]\[FilledVerySmallSquare]\[MediumSpace]", "InlineSeparator"]," "}}
				],
			#]&[
				Append[guideRefBox/@functions,
					Replace[name,{
						(n_->g_):>
							Cell[BoxData@guideGuideRefBox[None,g]],
						_->Nothing
						}]
					]
				]
		}],
		"InlineGuideFunctionListing"
		];
guideFunctionCell[functions_->description_,___]:=
	Cell[TextData@Flatten@{
		Riffle[guideRefBox/@Replace[functions,_Rule:>{functions}],", "],
		StyleBox[" \[LongDash] ", "GuideEmDash"],
		description
		},
		"GuideText"];
guideFunctionCell[text_String,___]:=
	Cell[text,"GuideText"];
guideFunctionCell[Delimiter,___]:=
	Cell["\t", "GuideDelimiterSubsection"];


iGuideSubsections[subsections_]:=
	Cell[CellGroupData[
		guideSubsection/@
			subsections
		]];


iGuideMain[title_,abstract_]:=
	Cell[CellGroupData@Flatten@{
		Cell[title,"GuideTitle"],
		Cell[#,"GuideAbstract"]&/@abstract
		}]


iGuideAnchorBar[name_,fs_,relatedGuides_]:=
	Cell[
		BoxData@
			ToBoxes@
				Grid[{{
					Grid[{{
						Item[
							Row@{
								Spacer[8],
								RawBoxes@Cell["GUIDE","PacletNameCell"],
								Spacer[8]
								},
							Background->docTypeColor["GUIDE"],
							ItemSize->Full]
							}},
						Alignment->{Automatic,Center},
						ItemSize->{{Full,Scaled[0.02`]},2.5}],
					RawBoxes@
						Cell[
							TextData@
								Riffle[{
									Cell[
										BoxData@ToBoxes@
											ActionMenu[Row@{"Functions","  ",docArrow},
												generateSymRefs[fs],
												Appearance->None,MenuAppearance->Automatic,
												BaseStyle->"AnchorBarActionMenu",
												MenuStyle->"GuideFunction"
												]
										],
									Cell[
										BoxData@ToBoxes@
											ActionMenu[Row@{"Related Guides","  ",docArrow},
												generateGuideRefs[relatedGuides],
												Appearance->None,MenuAppearance->Automatic,
												BaseStyle->"AnchorBarActionMenu",
												MenuStyle->"MoreAbout"
												]
										],
									Cell[
										BoxData@ToBoxes@
											ActionMenu[Row@{"URL","  ",docArrow},
												generateUrlRefs[name],
												Appearance->None,MenuAppearance->Automatic,
												BaseStyle->"AnchorBarActionMenu",
												MenuStyle->"URLMenu"
												]
										]
									},
								"\[ThickSpace]\[ThickSpace]\[ThickSpace]\[ThickSpace]\[ThickSpace]\[ThickSpace]"
								],
							"AnchorBar"]
					}},
				ItemSize->{{Scaled[0.35`],{Scaled[0.65`]}}, Automatic},
				Alignment->{{Left,Right},Center}
				],
		"AnchorBarGrid"
		];


iGuideRelatedSection[guides_,tuts_,links_]:=
	If[Length@Flatten@{guides,tuts,links}>0,
		Cell[CellGroupData@Flatten@{
			If[ListQ@guides&&Length@guides>0,
				Cell[CellGroupData@Flatten@{
					Cell["Related Guides", "GuideMoreAboutSection",
			 			WholeCellGroupOpener->True],
			 	 Cell[BoxData@guideRefBox[#,"GuideMoreAbout"],
			 	 	"GuideMoreAbout"]&/@guides
			 		}],
			 	Nothing
			 	],
			If[ListQ@tuts&&Length@tuts>0,
				Cell[CellGroupData@Flatten@{
					Cell["Related Tutorials", "GuideTutorialsSection",
			 			WholeCellGroupOpener->True],
			 	 Cell[BoxData@guideRefBox[#,"RelatedTutorials"],
			 	 	"RelatedTutorials"]&/@tuts
			 		}],
			 	Nothing
			 	],
			If[ListQ@links&&Length@links>0,
				Cell[CellGroupData@Flatten@{
					Cell["Related Links", "GuideRelatedLinksSection",
			 			WholeCellGroupOpener->True],
			 	 Cell[
						TextData@
							Cell[
								BoxData@
									TemplateBox[{First@#, Last@#},
								  	"WebLink",
									  BaseStyle->{"RelatedLinks"}
										]
								],
						"RelatedLinks"
						]&/@links
			 		}],
			 	Nothing
			 	]
			 }],
	 	Nothing
	 	];


iGuideMetadata[guideName_,guideLink_,abstract_]:=
	{
		"built"->ToString@First@DateObject[],
		"history"->{},
		"context"->"System`",
		"keywords"->{},
		"specialkeywords"->{},
		"tutorialcollectionlinks"->{},
		"index"->True,
		"label"->"Guide",
		"language"->"en",
		"paclet"->"Mathematica",
		"status"->"None",
		"summary"->First@Flatten@abstract,
		"synonyms"->{},
		"tabletags"->{},
		"title"->guideName,
		"titlemodifier"->"",
		"windowtitle"->guideName,
		"type"->"Guide",
		"uri"->StringTrim[pacletLinkBuild[guideLink,"guide"],"paclet:"]
		} 


iGenerateGuide[guideName_,guideLink_,abstract_,functions_,subsections_,
	related_,tuts_,links_]:=
	Block[{cid=1},
		Notebook[{
			iGuideAnchorBar[guideLink,functions,related],
			iGuideMain[guideName,abstract],
			iGuideSubsections[subsections],
			iGuideRelatedSection[related,tuts,links],
			Cell[" ", "FooterCell"]
			}/.Cell[e___]:>Cell[e,CellID->(cid++)],
			StyleDefinitions->
				Notebook[{
					Cell[
						StyleData[
							StyleDefinitions->
								FrontEnd`FileName[{"Wolfram"},
									"Reference.nb",CharacterEncoding->"UTF-8"]
							]
						],
					Cell[StyleData["Notebook"],
						DockedCells->
							{
								First@
									FrontEndResource["FEExpressions","HelpViewerToolbar"],
								Cell["",
									CellSize->{1,1},
									CellOpen->False,
									CellFrame->{{0,0},{2,0}},
									CellFrameColor->docTypeColor@"GUIDE"
									]
								}
						]
					}],
				TaggingRules->{
					"ColorType"->"GuideColor",
					"Metadata"->
						iGuideMetadata[guideName,guideLink,abstract]
						}
			]
		];


Options[GuideNotebook]={
	"Title"->None,
	"Abstract"->None,
	"Functions"->{},
	"Subsections"->{},
	"RelatedGuides"->{},
	"RelatedTutorials"->{},
	"RelatedLinks"->{}
	};
GuideNotebook[ops:OptionsPattern[]]:=
	With[{
		t=Replace[OptionValue@"Title",Except[_String|_Rule]:>"No Title"],
		a=Replace[Flatten@{OptionValue@"Abstract"},
			Except[{(_String|_TextData)..}]:>{"No description..."}],
		f=Replace[OptionValue@"Functions",Except[_List]:>{}],
		s=Replace[OptionValue@"Subsections",Except[_List]:>{}],
		g=Replace[OptionValue@"RelatedGuides",Except[_List]:>{}],
		rt=Replace[OptionValue@"RelatedTutorials",Except[_List]:>{}],
		l=Replace[OptionValue@"RelatedLinks",Except[_List]:>{}]
		},
		docGenBlock@
			iGenerateGuide[
				Replace[t,{(n_->_):>n}],
				Replace[t,{
					s_String:>
						StringReplace[s,Except[WordCharacter]->""],
					(_->n_):>
						n
					}],
				a,
				f,
				s,
				g,
				rt,
				l]
		];


Options[GenerateGuide]=
	Join[
		Options[GuideNotebook],
		Options[CreateDocument]
		];
GenerateGuide[ops:OptionsPattern[]]:=
	CreateDocument[
		GuideNotebook[FilterRules[{ops},Options@GuideNotebook]],
		FilterRules[{ops},Options@CreateDocument],
		WindowTitle->
			Replace[Lookup[{ops},"Title","No Title"],
				e:Except[_String]:>
					FirstCase[e,_String,"No Title",\[Infinity]]
				]<>" - Guide",
		System`ClosingSaveDialog->False,
		Saveable->False
		];
GenerateGuide[namePattern_String,ops:OptionsPattern[]]:=
	Block[{
		$DocActive=
			If[StringMatchQ[namePattern,"*`"],
				StringTrim[namePattern,"`"],
				$DocActive
				]
		},
		With[{names=Names[namePattern<>"*"]},
			DocFind; (* To get the DocFind package loaded for the private SymbolDetermineType *)
			With[{types=GroupBy[Keys@#,#]&@SymbolDetermineType[names]},
				GenerateGuide[
					"Title"->
						StringTrim[namePattern,"`"]<>" Symbols"->
							StringReplace[namePattern,Except["$"|WordCharacter]->""],
					"Abstract"->
						StringRiffle[
							Flatten@{
								Switch[Length@names,
									0,
										TemplateApply[
											"There are no symbols ``",
											{
												If[StringEndsQ[namePattern,"`"],
													"in the "<>StringTrim[namePattern,"`"]<>" context",
													"matching "<>namePattern
													]
												}
											],
									1,
										TemplateApply[
											"There is one symbol ``",
											{
												If[StringEndsQ[namePattern,"`"],
													"in the "<>StringTrim[namePattern,"`"]<>" context",
													"matching "<>namePattern
													]
												}
											],
									_,
										TemplateApply[
											"There are `` symbols ``",
											{
												Length@names,
												If[StringEndsQ[namePattern,"`"],
													"in the "<>StringTrim[namePattern,"`"]<>" context",
													"matching "<>namePattern
													]
												}
											]
									],
								KeyValueMap[
									TemplateApply[
										"`` ``",
										{
											Length@#2,
											If[Length@#2>1,
												"are "<>
													ToLowerCase@
														Replace[#,
															Except["Inert"]->#<>"s"
															],
												"is "<>
													ToLowerCase@
														Replace[#,
															Except["Inert"]->
																If[StringMatchQ[#,("A"|"E"|"I"|"O"|"U")~~__],
																	"an",
																	"a"
																	]<>" "<>#
															]
												]
											}]&,
									types
									]
								},
							"\n"],
					"Functions"->
						ToExpression[names,StandardForm,Hold],
					"Subsections"->
						KeyValueMap[
							Replace[#,
								Except["Inert"]->#<>"s"
								]->List@#2&,
							types
							],
					ops
					]
				]
			]
		];


GenerateGuide[nb_NotebookObject]:=
	Block[{$DocGenLine=0},
		GenerateGuide@#
		]&/@scrapeGuideTemplate@nb


Options[SaveGuide]=
	Options[GenerateGuide];
SaveGuide[
	guide:_String|None|{__String}:None,
	dir_String?DirectoryQ,
	extension:True|False:True,
	ops:OptionsPattern[]
	]:=
	Replace[
		If[guide===None,
			GenerateGuide[Visible->False,ops],
			GenerateGuide[guide,Visible->False,ops]
			],{
		nb:_NotebookObject|{__NotebookObject}:>(
			Quiet@CreateDirectory[
				FileNameJoin@{
					dir,
					If[extension,
						"Guides",
						Nothing
						]
					},
				CreateIntermediateDirectories->True
				];
			Map[
				Export[
					FileNameJoin@{
						dir,
						If[extension,
							"Guides",
							Nothing
							],
						URLParse[
							CurrentValue[
								#,
								{TaggingRules,"Metadata","uri"}
								],
							"Path"
							][[-1]]<>".nb"
						},
					DeleteCases[NotebookGet@#,Visible->_]
					]&,
				Flatten@{nb}
			]),
		_->$Failed
		}]


GuideGenButton=
	Button["Generate RefPages",
		With[{c=$Context},
			SelectionMove[EvaluationCell[],All,CellGroup
				AutoScroll->False];
			GenerateRefPages@InputNotebook[];
			If[$Context=!=c,End[]];
			SelectionMove[EvaluationCell[],After,Cell];
			],
		Method->"Queued"
		];


Options[GuideTemplate]=
	{
		"Title"->Automatic,
		"Link"->Automatic,
		"Abstract"->Automatic,
		"Functions"->Automatic,
		"Subsections"->Automatic,
		"RelatedGuides"->Automatic,
		"RelatedTutorials"->Automatic,
		"RelatedLinks"->Automatic
		};
GuideTemplate[s_String,ops:OptionsPattern[]]:=
	Notebook[{
		Cell[CellGroupData[
			Flatten@{
				Replace[OptionValue@"Title",{
					Automatic->
						Cell[s<>" Overview","GuideTitle"],
					t_String:>
						Cell[t,"GuideTitle"],
					Except[_List|_Cell]->{}
					}],
				Replace[OptionValue@"Link",{
					Automatic:>
						Cell[StringReplace[s,Except[WordCharacter]->""],"GuideLink"],
					l_String:>
						Cell[l,"GuideLink"],
					Except[_List|_Cell]->{}
					}],
				Replace[OptionValue@"Abstract",{
					Automatic:>
						Cell[s<>" description...","GuideAbstract"],
					a_String:>
						Cell[a,"GuideAbstract"],
					Except[_List|_Cell]->{}
					}],
				Replace[OptionValue@"Functions",{
					Automatic->{
						Cell["Guide Functions","GuideFunctionSubsection"],
						Cell["","GuideFunction"]
						},
					l:{__String}:>
						Cell[CellGroupData[Flatten@{
							Cell["Guide Functions","GuideFunctionSubsection"],
							Sequence@@
								Map[Cell[#,"GuideFunction"]&,l]
							},Closed]],
					Except[_List|_Cell]->{}
					}],
				Replace[OptionValue@"Subsections",{
					Automatic->{
						Cell["Guide Sections","GuideSubsectionSubsection"],
						Cell["Function - Description","GuideSubsectionItem"],
						Cell["Guide | Link","GuideSubsectionItem"],
						Cell["Function","GuideSubsectionItem"]
						},
					r:{__Rule}:>{
						Cell["Guide Sections","GuideSubsectionSubsection"],
						Map[
							Cell[CellGroupData[Flatten@{
								Cell[
									Replace[First@#,{
										(t_->g_):>
											t<>" | "<>g,
										g_:>
											If[StringContainsQ[g," | "],
												g,
												g<>" |"
												]
										}],"GuideSubsectionItem"],
								Cell[#,"GuideSubsectionItem"]&/@Last@#
								}]]&,
							r
							]
						},
					Except[_List|_Cell]->{}
					}],
				Replace[OptionValue@"RelatedGuides",{
					Automatic->{
						Cell["Related Guide","GuidesSection"],
						Cell["Related Guide Title | RelatedGuide",
							"RelatedGuide"]
						},
					l:{(_String|_Rule)..}:>
						{
							Cell["Related Guide","GuidesSection"],
							Map[
								Cell[
									First@#<>" | "<>
										StringReplace[Last@#,Except[WordCharacter]->""],
									"RelatedGuide"]&,
								Replace[l,
									t_String:>(t->t),
									1]
								]
							},
					Except[_List|_Cell]->{}
					}],
				Replace[OptionValue@"RelatedTutorials",{
					Automatic->{
						Cell["Related Tutorials","TutorialSection"],
						Cell["Related Tutorial Title | RelatedTutorial",
							"RelatedTutorial"]
						},
					l:{(_String|_Rule)..}:>
						{
							Cell["Related Tutorials","TutorialSection"],
							Map[
								Cell[
									First@#<>" | "<>
										StringReplace[Last@#,Except[WordCharacter]->""],
									"RelatedTutorial"]&,
								Replace[l,
									t_String:>(t->t),
									1]
								]
							},
					Except[_List|_Cell]->{}
					}],
				Replace[OptionValue@"RelatedLinks",{
					Automatic->{
						Cell["Related Links","LinksSection"],
						Cell["Related Link Title | RelatedLink","RelatedLink"]
						},
					l:{(_String|_Rule)..}:>
						{
							Cell["Related Tutorials","LinksSection"],
							Map[
								Cell[
									First@#<>" | "<>
										StringReplace[Last@#,Except[WordCharacter]->""],
									"RelatedTutorial"]&,
								Replace[l,
									t_String:>(
										URLBuild[
											ReplacePart[
												URLParse[t],{
												"Scheme"->None,
												"Query"->{}
												}]
											]->t),
									1]
								]
							},
					Except[_List|_Cell]->{}
					}],
				Cell["","SectionSeparator"]
				},
			Open]
			]
		},
		StyleDefinitions->
			With[{p=`Package`$PackageName},
				FrontEnd`FileName[{p},"DocGen.nb"]
				]
		];
GuideTemplate[s:{__String},ops:OptionsPattern[]]:=
	Notebook[Flatten[First@GuideTemplate[#,ops]&/@s],
		StyleDefinitions->
			With[{p=`Package`$PackageName},
				FrontEnd`FileName[{p},"DocGen.nb"]
				]
		];


GuideContextTemplate[pat_]:=
	GuideTemplate[pat,
		"Title"->pat<>" Context Overview",
		"Functions"->Names[pat<>"*"]
		]


scrapeGuideChunk[c:{__Cell}]:=
	docGenBlock[
		With[{
			title=FirstCase[c,Cell[s_,___,"GuideTitle",___]:>s],
			link=FirstCase[c,Cell[l_,___,"GuideLink",___]:>l,None],
			ab=Cases[c,Cell[ab_,___,"GuideAbstract",___]:>ab],
			funcs=Cases[c,Cell[f_,"GuideFunction",___]:>f],
			subsections=Cases[c,Cell[s_,"GuideSubsectionItem",___]:>s],
			guides=Cases[c,Cell[__,"RelatedGuide",___]],
			tuts=Cases[c,Cell[__,"RelatedTutorial",___]],
			links=Cases[c,Cell[__,"RelatedLink",___]]
			},
			{
				"Title"->
					If[link===None,title,title->link],
				"Abstract"->
					ab,
				"Functions"->
					StringTrim/@funcs,
				"Subsections"->
					Replace[
						DeleteCases[
							SplitBy[
								Replace[subsections,{
									s_String?(StringMatchQ["* - *"]):>
										With[{spl=StringSplit[s," - ",2]},
											StringTrim@StringSplit[First@spl,","]->
												Last@spl
											],
									s_String?(StringMatchQ["* |*"]):>
										Sequence@@{
											"- BreakPoint -",
											Rule@@StringSplit[s," |",2]
											},
									"Delimiter"|"----"|"":>
										Delimiter
									},
									1],
								MatchQ[#,"- BreakPoint -"]&
								],
							{"- BreakPoint -"}
							],{
					{Delimiter}->Delimiter,
					{r:(_String->_),e___}:>
						If[MatchQ[StringTrim@Last@r,
								_String?symString],
							StringTrim/@r,
							StringTrim@First@r
							]->
							Replace[
								SplitBy[{e},
									MatchQ[_String?symString]],
								l:Except[
									_?(AllTrue[#,MatchQ[_String?symString]]&)
									]:>
									Sequence@@l,
								1],
					l_List:>
						None->
							Replace[
								SplitBy[l,
									MatchQ[_String?symString]],
								l2:Except[
									_?(AllTrue[#,MatchQ[_String?symString]]&)
									]:>
									Sequence@@l2,
								1]
					},
					1],
				"RelatedGuides"->
					Replace[First/@guides,{
						s_String:>
							Replace[StringSplit[s," | "],{
								{str_}:>
									str->pacletLinkBuild[str,"guide"],
								{l_,g_}:>
									l->pacletLinkBuild[g,"guide"]
								}],
						_->Nothing
						},
						1],
				"RelatedTutorials"->
					Replace[First/@tuts,{
						s_String:>
							Replace[StringSplit[s," | "],{
								{str_}:>
									str->pacletLinkBuild[str,"tutorial"],
								{l_,g_}:>
									l->pacletLinkBuild[g,"tutorial"]
								}],
						_->Nothing
						},
						1],
				"RelatedLinks"->
					Replace[First/@links,{
						s_String:>
							Replace[StringSplit[s," | "],{
								{str_}:>
									str->str,
								{l_,g_}:>
									l->g
								}],
						_->Nothing
						},
						1],
				WindowTitle->
					Replace[link,Except[_String]->title]
				}
			]
		];
scrapeGuideTemplate[c:{__Cell}]:=
	With[{cells=NotebookTools`FlattenCellGroups@c},
		scrapeGuideChunk@cells[[#]]&/@
			Replace[
				Flatten@Position[cells,Cell[__,"GuideTitle",___]],{
					i:{__}:>
						Span@@@Partition[Riffle[i,Append[Rest@i-1,-1]],2]
				}]
		]


scrapeGuideTemplate[cells:{__CellObject}]:=
	scrapeGuideTemplate[NotebookRead/@cells];
scrapeGuideTemplate[nb_NotebookObject]:=
	scrapeGuideTemplate@
		Replace[NotebookRead@nb,{
			c_Cell:>
				{c},
			c:{__Cell}:>
				c,
			_:>
				Cells@nb
			}];


(* ::Subsection:: *)
(*Tutorials*)



tutorialChunk["Section",text_,ops___]:=
	Cell[text,"Section",ops];
tutorialChunk["Emphasis",text_,ops___]:=
	Cell[text,"TextEmphasisNote",ops];
tutorialChunk["Text",text_,ops___]:=
	Cell[parseRefText@text,"Text",ops];
tutorialChunk["Input",text_,ops___]:=
	Cell[text,"Input",ops];
tutorialChunk["Output",text_,ops___]:=
	Cell[text,"Output",ops];
tutorialChunk["Picture",img_,ops___]:=
	Cell[img,"Picture",ops];
tutorialChunk["Caption",img_,ops___]:=
	Cell[img,"Caption",ops];


tutorialChunk["Grid",grid_,ops___]:=
	With[{ml=Max@Map[Length,grid]},
		Cell[
			BoxData[GridBox[
					PadRight[#,ml,""]&/@
						MapIndexed[
							If[Last@#2===1,
								parseRefText[#],
								Replace[parseRefText[#],{
									(d:_TextData|_BoxData|_String)|Cell[d_,___]:>
										Cell[d,"TableText"],
									e_:>
										Cell[BoxData[e],"TableText"]
									}]
								]&,
							grid,
							{2}
							]
						]
					],
			"DefinitionBox",
			ops
			]
		]


tutorialJumpLinkIcon=ToBoxes@Image[RawArray["UnsignedInteger8",{{{128, 128, 128, 32}, {128, 128, 128, 16}, {128, 128, 128, 0}, {128, 128, 128, 0}, {128, 128, 128, 0}, {128, 128, 128, 0}, {128, 128, 128, 0}, {128, 128, 128, 48}}, {{128, 128, 128, 48}, {128, 128, 128, 239}, {128, 128, 128, 112}, {128, 128, 128, 0}, {128, 128, 128, 0}, {128, 128, 128, 16}, {128, 128, 128, 143}, {128, 128, 128, 239}}, {{128, 128, 128, 0}, {128, 128, 128, 64}, {128, 128, 128, 223}, {128, 128, 128, 191}, {128, 128, 128, 112}, {128, 128, 128, 223}, {128, 128, 128, 191}, {128, 128, 128, 32}}, {{128, 128, 128, 32}, {128, 128, 128, 16}, {128, 128, 128, 16}, {128, 128, 128, 175}, {128, 128, 128, 255}, {128, 128, 128, 127}, {128, 128, 128, 0}, {128, 128, 128, 48}}, {{128, 128, 128, 48}, {128, 128, 128, 239}, {128, 128, 128, 112}, {128, 128, 128, 0}, {128, 128, 128, 16}, {128, 128, 128, 16}, {128, 128, 128, 143}, {128, 128, 128, 239}}, {{128, 128, 128, 0}, {128, 128, 128, 64}, {128, 128, 128, 223}, {128, 128, 128, 191}, {128, 128, 128, 112}, {128, 128, 128, 223}, {128, 128, 128, 191}, {128, 128, 128, 32}}, {{128, 128, 128, 0}, {128, 128, 128, 0}, {128, 128, 128, 16}, {128, 128, 128, 175}, {128, 128, 128, 255}, {128, 128, 128, 127}, {128, 128, 128, 0}, {128, 128, 128, 0}}, {{128, 128, 128, 0}, {128, 128, 128, 0}, {128, 128, 128, 0}, {128, 128, 128, 0}, {128, 128, 128, 16}, {128, 128, 128, 0}, {128, 128, 128, 0}, {128, 128, 128, 0}}}], "Byte", ColorSpace -> "RGB", ImageSize -> {8, 9}, Interleaving -> True, MetaInformation -> Association["Comments" -> Association["Software" -> "Adobe ImageReady"]]];
tutroialJumpLinkIconActive=ToBoxes@Image[RawArray["UnsignedInteger8",{{{229, 95, 28, 32}, {229, 95, 28, 16}, {229, 95, 28, 0}, {229, 95, 28, 0}, {229, 95, 28, 0}, {229, 95, 28, 0}, {229, 95, 28, 0}, {229, 95, 28, 48}}, {{229, 95, 28, 48}, {229, 95, 28, 239}, {229, 95, 28, 112}, {229, 95, 28, 0}, {229, 95, 28, 0}, {229, 95, 28, 16}, {229, 95, 28, 143}, {229, 95, 28, 239}}, {{229, 95, 28, 0}, {229, 95, 28, 64}, {229, 95, 28, 223}, {229, 95, 28, 191}, {229, 95, 28, 112}, {229, 95, 28, 223}, {229, 95, 28, 191}, {229, 95, 28, 32}}, {{229, 95, 28, 32}, {229, 95, 28, 16}, {229, 95, 28, 16}, {229, 95, 28, 175}, {229, 95, 28, 255}, {229, 95, 28, 127}, {229, 95, 28, 0}, {229, 95, 28, 48}}, {{229, 95, 28, 48}, {229, 95, 28, 239}, {229, 95, 28, 112}, {229, 95, 28, 0}, {229, 95, 28, 16}, {229, 95, 28, 16}, {229, 95, 28, 143}, {229, 95, 28, 239}}, {{229, 95, 28, 0}, {229, 95, 28, 64}, {229, 95, 28, 223}, {229, 95, 28, 191}, {229, 95, 28, 112}, {229, 95, 28, 223}, {229, 95, 28, 191}, {229, 95, 28, 32}}, {{229, 95, 28, 0}, {229, 95, 28, 0}, {229, 95, 28, 16}, {229, 95, 28, 175}, {229, 95, 28, 255}, {229, 95, 28, 127}, {229, 95, 28, 0}, {229, 95, 28, 0}}, {{229, 95, 28, 0}, {229, 95, 28, 0}, {229, 95, 28, 0}, {229, 95, 28, 0}, {229, 95, 28, 16}, {229, 95, 28, 0}, {229, 95, 28, 0}, {229, 95, 28, 0}}}], "Byte", ColorSpace -> "RGB", ImageSize -> {8, 9}, Interleaving -> True];
tutorialChunk["JumpLink",title_,to_,ops___]:=
	TemplateBox[{
    Cell[title],to,
    	tutorialJumpLinkIcon,
    	tutroialJumpLinkIconActive
    },
    "GrayLinkWithIcon",
    BaseStyle->{"TutorialJumpBoxLink"}];
tutorialChunk["LinkColumns",rawLinks_,n_,ops___]:=
	With[{links=
		Replace[rawLinks,
			(title_->to_):>
				tutorialChunk["JumpLink",title,to],
			1
			]
		},
 	Cell[
 		BoxData[
 			GridBox[
		 		Transpose@{
		 			Take[links,n],
			 		PadRight[Take[links,{n+1,-1}],n,""]
			 		}
		 		]
			],
 		"TutorialJumpBox",
 		ops]
 	];


tutorialChunk[data_->style_]:=
	tutorialChunk[style,data]
tutorialChunk[data:_TextData|_String]:=
	tutorialChunk["Text",data];
tutorialChunk[data_BoxData]:=
	tutorialChunk["Input",data];
tutorialChunk[data_List]:=
	If[MatchQ[First@data,_Rule],
		tutorialChunk["LinkColumns",data,
			Ceiling[Length@data/2]
			],
		tutorialChunk["Grid",data]
		];
tutorialChunk[Cell[d_,style_,ops___]]:=
	tutorialChunk[
		Replace[style,{
			"TutorialInput"->"Input",
			"TutorialOutput"->"Output",
			"TutorialText"->"Text",
			"TutorialJumpLink"->"JumpLink",
			"TutorialImage"->"Picture",
			"TutorialCaption"->"Caption",
			"TutorialSubsection"->
				"Section"
			}],
		d,
		ops]


iTutorialSections[subsections_]:=
	Cell[CellGroupData[
		tutorialChunk/@
			(subsections)
		]];


iTutorialAnchorBar[name_,fs_,guides_,tuts_]:=
	Cell[
		BoxData@
			ToBoxes@
				Grid[{{
					Grid[{{
						Item[
							Row@{
								Spacer[8],
								RawBoxes@Cell["TUTORIAL","PacletNameCell"],
								Spacer[8]
								},
							Background->docTypeColor["TUTORIAL"],
							ItemSize->Full]
							}},
						Alignment->{Automatic,Center},
						ItemSize->{{Full,Scaled[0.02`]},2.5}],
					RawBoxes@
						Cell[
							TextData@
								Riffle[{
									Cell[
										BoxData@ToBoxes@
											ActionMenu[Row@{"Related Tutorials","  ",docArrow},
												generateGuideRefs[tuts],
												Appearance->None,MenuAppearance->Automatic,
												BaseStyle->"AnchorBarActionMenu",
												MenuStyle->"RelatedTutorialsSection"
												]
										],
									Cell[
										BoxData@ToBoxes@
											ActionMenu[Row@{"Related Guides","  ",docArrow},
												generateGuideRefs[guides],
												Appearance->None,MenuAppearance->Automatic,
												BaseStyle->"AnchorBarActionMenu",
												MenuStyle->"TutorialMoreAboutSection"
												]
										],
									Cell[
										BoxData@ToBoxes@
											ActionMenu[Row@{"Functions","  ",docArrow},
												generateSymRefs[fs],
												Appearance->None,MenuAppearance->Automatic,
												BaseStyle->"AnchorBarActionMenu",
												MenuStyle->"GuideFunction"
												]
										],
									Cell[
										BoxData@ToBoxes@
											ActionMenu[Row@{"URL","  ",docArrow},
												generateUrlRefs[name],
												Appearance->None,MenuAppearance->Automatic,
												BaseStyle->"AnchorBarActionMenu",
												MenuStyle->"URLMenu"
												]
										]
									},
								"\[ThickSpace]\[ThickSpace]\[ThickSpace]\[ThickSpace]\[ThickSpace]\[ThickSpace]"
								],
							"AnchorBar"]
					}},
				ItemSize->{{Scaled[0.35`],{Scaled[0.65`]}}, Automatic},
				Alignment->{{Left,Right},Center}
				],
		"AnchorBarGrid"
		];


iTutorialMain[title_,linkblock_:{}]:=
	Cell[CellGroupData@Flatten@{
		Cell[title,"Title"],
		tutorialChunk@Replace[linkblock,{
			links:{__}:>
				Thread[links->links]
			}]
		}]


iTutorialRelatedSection[guides_,tuts_,links_]:=
	If[Length@Flatten@{guides,tuts,links}>0,
		Cell[CellGroupData@Flatten@{
			If[ListQ@guides&&Length@guides>0,
				Cell[CellGroupData@Flatten@{
					Cell["Related Guides", "TutorialMoreAboutSection",
			 			WholeCellGroupOpener->True],
			 	 Cell[BoxData@guideRefBox[#,"TutorialMoreAbout"],
			 	 	"TutorialMoreAbout"]&/@guides
			 		}],
			 	Nothing
			 	],
			If[ListQ@links&&Length@tuts>0,
				Cell[CellGroupData@Flatten@{
					Cell["Related Tutorials", "RelatedTutorialsSection",
			 			WholeCellGroupOpener->True],
			 	 Cell[BoxData@guideRefBox[#,"RelatedTutorials"],
			 	 	"RelatedTutorials"]&/@tuts
			 		}],
			 	Nothing
			 	],
			If[ListQ@links&&Length@links>0,
				Cell[CellGroupData@Flatten@{
					Cell["Related Links", "TutorialRelatedLinksSection",
						WholeCellGroupOpener->True],
					Cell[
						TextData@
							Cell[
								BoxData@
									TemplateBox[{First@#, Last@#},
								  	"WebLink",
									  BaseStyle->{"TutorialRelatedLinks"}
										]
								],
						"TutorialRelatedLinks"
						]&/@links
			 		}],
			 	Nothing
			 	]
			 }],
	 	Nothing
	 	];


iTutorialMetadata[guideName_,guideLink_,abstract_]:=
	{
		"built"->ToString@First@DateObject[],
		"history"->{},
		"context"->"System`",
		"keywords"->{},
		"specialkeywords"->{},
		"tutorialcollectionlinks"->{},
		"index"->True,
		"label"->"Tutorial",
		"language"->"en",
		"paclet"->"Mathematica",
		"status"->"None",
		"summary"->abstract,
		"synonyms"->{},
		"tabletags"->{},
		"title"->guideName,
		"titlemodifier"->"",
		"windowtitle"->guideName,
		"type"->"Tutorial",
		"uri"->StringTrim[pacletLinkBuild[guideLink,"tutorial"],"paclet:"]
		} 


tutorialPostProcessJumpLinks[nb_]:=
	With[{
		uri=
			Lookup[
				Lookup[TaggingRules/.Options[nb,TaggingRules],"Metadata"],
				"uri"
				],
		links=
			Cases[First@nb,
				TemplateBox[{_,_,_,_},"GrayLinkWithIcon",___],
				\[Infinity]
				]
		},
		With[{reps=
			Select[DeleteDuplicates[links],
				Not@StringMatchQ[#[[1,2]],"paclet:*"|"http:*"|"https:*"]&
				]
			},
			ReplacePart[nb,
				1->
					ReplaceAll[First@nb,
						Map[#->
								ReplacePart[#,
									{1,2}->
										"paclet:"<>
											Replace[
												FirstCase[First@nb,
													Cell[
														Replace[#[[1,1]],{
															Cell[c_,e___]:>
																c|Cell[c,e]
															}],"Section",___,
															CellID->id_,___]:>
														id,
													None,
													\[Infinity]
													],{
													None->uri,
													e_:>uri<>"#"<>ToString[e]
												}]
									]&,
							reps
							]			
						]
				]
			]
		];


iGenerateTutorial[guideName_,guideLink_,abstract_,sections_,
	functions_,relatedGuides_,relatedTutorials_,relatedLinks_]:=
	tutorialPostProcessJumpLinks@Block[{cid=1},
		Notebook[{
			iTutorialAnchorBar[guideLink,functions,relatedGuides,relatedTutorials],
			iTutorialMain[guideName,
				Cases[sections,
					Cell[c_,"TutorialSubsection",___]:>c
					]],
			iTutorialSections[sections],
			iTutorialRelatedSection[
				relatedGuides,
				relatedTutorials,
				relatedLinks],
			Cell[" ", "FooterCell"]
			}//.Cell[e__,
				l:Except[CellID->_]
				]:>Cell[e,l,(CellID->(cid++))],
			StyleDefinitions->
				Notebook[{
					Cell[
						StyleData[
							StyleDefinitions->
								FrontEnd`FileName[{"Wolfram"},
									"Reference.nb",CharacterEncoding->"UTF-8"]
							]
						],
					Cell[StyleData["Notebook"],
						DockedCells->
							{
								First@
									FrontEndResource["FEExpressions","HelpViewerToolbar"],
								Cell["",
									CellSize->{1,1},
									CellOpen->False,
									CellFrame->{{0,0},{2,0}},
									CellFrameColor->docTypeColor@"TUTORIAL"
									]
								}
						]
					}],
				TaggingRules->{
					"ColorType"->"TutorialColor",
					"Metadata"->
						iTutorialMetadata[guideName,guideLink,abstract]
						}
			]
		];


Options[TutorialNotebook]={
	"Title"->None,
	"Abstract"->Automatic,
	"Functions"->{},
	"Sections"->{},
	"RelatedGuides"->{},
	"RelatedTutorials"->{},
	"RelatedLinks"->{}
	};
TutorialNotebook[ops:OptionsPattern[]]:=
	With[{
		t=Replace[OptionValue@"Title",Except[_String|_Rule]:>"No Title"],
		a=OptionValue@"Abstract",
		fs=Replace[OptionValue@"Functions",Except[_List]:>{}],
		s=Replace[OptionValue@"Sections",Except[_List]:>{}],
		g=Replace[OptionValue@"RelatedGuides",Except[_List]:>{}],
		rt=Replace[OptionValue@"RelatedTutorials",Except[_List]:>{}],
		l=Replace[OptionValue@"RelatedLinks",Except[_List]:>{}]
		},
		docGenBlock@
			iGenerateTutorial[
				Replace[t,{(n_->_):>n}],
				Replace[t,{
					s_String:>
						StringReplace[s,Except[WordCharacter]->""],
					(_->n_):>
						n
					}],
				Replace[a,
					Except[_String]:>
						FirstCase[s,_String,"No description..."]
					],
				s,
				fs,
				g,
				rt,
				l]
		];


Options[GenerateTutorial]=
	Join[
		Options[TutorialNotebook],
		Options[CreateDocument]
		];
GenerateTutorial[ops:OptionsPattern[]]:=
	CreateDocument[
		TutorialNotebook[FilterRules[{ops},Options@TutorialNotebook]],
		FilterRules[{ops},Options@CreateDocument],
		WindowTitle->
			Replace[Lookup[{ops},"Title","No Title"],
				e:Except[_String]:>
					FirstCase[e,_String,"No Title",\[Infinity]]
				]<>" - Guide",
		ClosingSaveDialog->False,
		Saveable->False
		];


GenerateTutorial[nb_NotebookObject]:=
	Block[{$DocGenLine=0},
		GenerateTutorial@#
		]&/@scrapeTutorialTemplate@nb


Options[TutorialTemplate]=
	{
		"Title"->Automatic,
		"Link"->Automatic,
		"Description"->Automatic,
		"Functions"->Automatic,
		"Content"->Automatic,
		"RelatedGuides"->Automatic,
		"RelatedTutorials"->Automatic,
		"RelatedLinks"->Automatic
		};
TutorialTemplate[s_String,ops:OptionsPattern[]]:=
	Notebook[{
		Cell[CellGroupData[
			Flatten@{
				Replace[OptionValue@"Title",{
					Automatic->
						Cell[s<>" Tutorial","TutorialTitle"],
					t_String:>
						Cell[t,"TutorialTitle"],
					Except[_List|_Cell]->{}
					}],
				Replace[OptionValue@"Link",{
					Automatic:>
						Cell[StringReplace[s,Except[WordCharacter]->""],
							"TutorialLink"],
					l_String:>
						Cell[l,"TutorialLink"],
					Except[_List|_Cell]->{}
					}],
				Replace[OptionValue@"Description",{
					Automatic:>
						Cell[s<>" description...","TutorialText"],
					a_String:>
						Cell[a,"TutorialText"],
					Except[_List|_Cell]->{}
					}],
				Replace[OptionValue@"Content",{
					Automatic->{
						Cell["Tutorial content...","TutorialText"]
						},
					c:{(_String|_List|_Rule)..}:>
						Replace[c,{
							t_String:>
								Cell[t,"TutorialText"],
							l_List:>
								Map[
									{
										Cell[
											Replace[First@#,
												b:Except[_String|_?BoxQ]:>
													BoxData@ToBoxes@b
												],
											"TutorialTableRow"],
										Cell[
											Replace[Last@#,
												b:Except[_String|_?BoxQ]:>
													BoxData@ToBoxes@b
												],
											"TutorialTableColumn"]
										}&,
									l],
							(sec_->stuff_):>
								Cell[CellGroupData[Flatten@{
									Cell[sec,"TutorialSubsection"],
									Replace[Flatten[{stuff},1],{
										t_String?makeRefTest:>
											BoxData@inlineRefBox[t],
										t_String:>
											Cell[t,"TutorialText"],
										l_List:>
											Map[
												Flatten@{
													Cell[
														Replace[First@#,{
															b:Except[_String|_?BoxQ]:>
																BoxData@ToBoxes@b,
															t_String?makeRefTest:>
																BoxData@inlineRefBox[t]
															}],
														"TutorialTableRow"],
													Map[
														Cell[
															Replace[#,{
																b:Except[_String|_?BoxQ]:>
																	BoxData@ToBoxes@b,
																t_String?makeRefTest:>
																	BoxData@inlineRefBox[t]
																}],
															"TutorialTableColumn"]&,
														Rest@#
														]
													}&,
												l],
										i_?ImageQ:>
											Cell[BoxData@ToBoxes@i,
												"TutorialImage"
												],
										(i_?ImageQ->cap_):>
											Cell[
												CellGroupData[{
													Cell[BoxData@ToBoxes@i,
														"TutorialImage"
														],
													Cell[cap,
														"TutorialCaption"
														]
													}]
												]
										},
										1]
									}]
									]		
							},
							1]
					}],
				Replace[OptionValue@"Functions",{
					Automatic->{
						Cell["Related Functions","SeeAlsoSection"],
						Cell["","SeeAlso"]
						},
					l:{__String}:>
						Cell[CellGroupData[Flatten@{
							Cell["Related Functions","SeeAlsoSection"],
							Sequence@@
								Map[Cell[#,"SeeAlso"]&,l]
							},Closed]],
					Except[_List|_Cell]->{}
					}],
				Replace[OptionValue@"RelatedGuides",{
					Automatic->{
						Cell["Related Guides","GuidesSection"],
						Cell["Related Guide Title | RelatedGuide",
							"RelatedGuide"]
						},
					l:{(_String|_Rule)..}:>
						{
							Cell["Related Guides","GuidesSection"],
							Map[
								Cell[
									First@#<>" | "<>
										StringReplace[Last@#,Except[WordCharacter]->""],
									"RelatedGuide"]&,
								Replace[l,
									t_String:>(t->t),
									1]
								]
							},
					Except[_List|_Cell]->{}
					}],
				Replace[OptionValue@"RelatedTutorials",{
					Automatic->{
						Cell["Related Tutorials","TutorialSection"],
						Cell["Related Tutorial Title | RelatedTutorial",
							"RelatedTutorial"]
						},
					l:{(_String|_Rule)..}:>
						{
							Cell["Related Tutorials","TutorialSection"],
							Map[
								Cell[
									First@#<>" | "<>
										StringReplace[Last@#,Except[WordCharacter]->""],
									"RelatedTutorial"]&,
								Replace[l,
									t_String:>(t->t),
									1]
								]
							},
					Except[_List|_Cell]->{}
					}],
				Replace[OptionValue@"RelatedLinks",{
					Automatic->{
						Cell["Related Links","LinksSection"],
						Cell["Related Link Title | RelatedLink","RelatedLink"]
						},
					l:{(_String|_Rule)..}:>
						{
							Cell["Related Tutorials","LinksSection"],
							Map[
								Cell[
									First@#<>" | "<>
										StringReplace[Last@#,Except[WordCharacter]->""],
									"RelatedTutorial"]&,
								Replace[l,
									t_String:>(
										URLBuild[
											ReplacePart[
												URLParse[t],{
												"Scheme"->None,
												"Query"->{}
												}]
											]->t),
									1]
								]
							},
					Except[_List|_Cell]->{}
					}],
				Cell["","SectionSeparator"]
				},
			Open]
			]
		},
		StyleDefinitions->
			With[{p=`Package`$PackageName},
				FrontEnd`FileName[{p},"DocGen.nb"]
				]
		];
TutorialTemplate[s:{__String},ops:OptionsPattern[]]:=
	Notebook[Flatten[First@TutorialTemplate[#,ops]&/@s],
		StyleDefinitions->
			With[{p=`Package`$PackageName},
				FrontEnd`FileName[{p},"DocGen.nb"]
				]
		];


TutorialContextTemplate[pat_]:=
	TutorialTemplate[pat<>" Tutorial",Names[pat<>"*"]]


scrapeTutorialChunk[c:{__Cell}]:=
	docGenBlock[
		With[{
			title=FirstCase[c,Cell[s_,___,"TutorialTitle",___]:>s],
			link=FirstCase[c,Cell[l_,___,"TutorialLink",___]:>l,None],
			content=
				Cases[c,
					Cell[_,___,
						"TutorialText"|"TutorialInput"|"TutorialOutput"|
						"TutorialImage"|
						"TutorialJumpLink"|"TutorialCaption"|
						"TutorialSubsection"|"TutorialTableRow"|
						"TutorialTableColumn",
						___]],
			funcs=Cases[c,Cell[f_,"SeeAlso",___]:>f],
			guides=Cases[c,Cell[__,"RelatedGuide",___]],
			tuts=Cases[c,Cell[__,"RelatedTutorial",___]],
			links=Cases[c,Cell[__,"RelatedLink",___]]
			},
			{
				"Title"->
					If[link===None,title,title->link],
				"Abstract"->
					FirstCase[content,
						Cell[t_,"TutorialText",___]:>t
						],
				"Functions"->
					Replace[funcs,{
						s_String?(StringMatchQ["* -> *"]):>
							Rule@@StringSplit[s," -> "],
						s_String?symString:>
							ToExpression[s,StandardForm,Hold],
						_->Nothing
						},
						1],
				"Sections"->
					Replace[
						SplitBy[content,
							Replace[{
								Cell[_,"TutorialJumpLink",___]->
									1,
								Cell[_,"TutorialTableRow"|"TutorialTableColumn",___]->
									-1,
								_->0
								}]
							],{
						l:{Cell[_,"TutorialTableRow",___],___}:>
							SequenceCases[l,
								l2:{
									Cell[_,"TutorialTableRow",___],
									Except[Cell[_,"TutorialTableRow",___]]...
									}:>
									ReplacePart[l2,
										{_,2}->"Text"
										]
								],
						e:Except[{Cell[_,"TutorialJumpLink",___],___}]:>
							(Sequence@@e)
						},
						1],
				"RelatedGuides"->
					Replace[First/@guides,{
						s_String:>
							Replace[StringSplit[s," | "],{
								{str_}:>
									str->pacletLinkBuild[str,"guide"],
								{l_,g_}:>
									l->pacletLinkBuild[g,"guide"]
								}],
						_->Nothing
						},
						1],
				"RelatedTutorials"->
					Replace[First/@tuts,{
						s_String:>
							Replace[StringSplit[s," | "],{
								{str_}:>
									str->pacletLinkBuild[str,"tutorial"],
								{l_,g_}:>
									l->pacletLinkBuild[g,"tutorial"]
								}],
						_->Nothing
						},
						1],
				"RelatedLinks"->
					Replace[First/@links,{
						s_String:>
							Replace[StringSplit[s," | "],{
								{str_}:>
									str->str,
								{l_,g_}:>
									l->g
								}],
						_->Nothing
						},
						1],
				WindowTitle->
					Replace[link,Except[_String]->title]
				}
			]
		];
scrapeTutorialTemplate[c:{__Cell}]:=
	With[{cells=NotebookTools`FlattenCellGroups@c},
		scrapeTutorialChunk@cells[[#]]&/@
			Replace[
				Flatten@Position[cells,Cell[__,"TutorialTitle",___]],{
					i:{__}:>
						Span@@@Partition[Riffle[i,Append[Rest@i-1,-1]],2]
				}]
		]


scrapeTutorialTemplate[cells:{__CellObject}]:=
	scrapeTutorialTemplate[NotebookRead/@cells];
scrapeTutorialTemplate[nb_NotebookObject]:=
	scrapeTutorialTemplate@
		Replace[NotebookRead@nb,{
			c_Cell:>
				{c},
			c:{__Cell}:>
				c,
			_:>
				Cells@nb
			}];


(* ::Subsection:: *)
(*Helpers*)



IndexDocumentation[
	src_String?DirectoryQ,
	dest:_String?DirectoryQ|Automatic:Automatic
	]:=
	With[{
		indexDir=Replace[dest,Automatic:>FileNameJoin@{src,"Index"}],
		spellInd=Replace[dest,Automatic:>FileNameJoin@{src,"SpellIndex"}]
		},
		Needs["DocumentationSearch`"];
		Quiet@DeleteDirectory[indexDir, DeleteContents -> True];
		With[{ind=DocumentationSearch`NewDocumentationNotebookIndexer[indexDir]},
			Map[
				DocumentationSearch`AddDocumentationNotebook[
					ind,
					#]&,
					FileNames["*.nb",src,\[Infinity]]
				];
			DocumentationSearch`CloseDocumentationNotebookIndexer[ind];
			];
		Quiet@DeleteDirectory[spellInd, DeleteContents -> True];
		DocumentationSearch`CreateSpellIndex[indexDir,spellInd];
		indexDir
		];


Options[generateDocumentation]=
	Join[
		Options@GenerateRefPages,
		Options@GenerateGuide,{
		"Install"->False,
		"Index"->Automatic
		}];
generateDocumentation[
	pattern:_String,
	base:_String?DirectoryQ|Automatic:Automatic,
	open:True|False:True,
	ops:OptionsPattern[]
	]:=
	With[{
		pacletBase=
			FileNameJoin@{
				Replace[base,
					Automatic:>
						FileNameJoin@{
							$TemporaryDirectory,
							"doc_paclets"
							}
					],
				StringReplace[pattern,Except["$"|WordCharacter]->""]
				}
		},
		With[{
			dir=
				FileNameJoin@{
					pacletBase,
					"Documentation",
					"English"
					},
			linkbase=
				StringReplace[pattern,
					Except[WordCharacter]->""
					]
			},
			Quiet@DeleteDirectory[dir,DeleteContents->True];
			CreateDirectory[dir,
				CreateIntermediateDirectories->True
				];
			Block[{$DocActive=linkbase},
				SaveRefPages[pattern,dir,
					Sequence@@
						DeleteDuplicatesBy[First]@
						FilterRules[{
							ops,
							"RelatedGuides"->(linkbase<>"/guide/"<>linkbase)
							},
							Options@SaveRefPages
							]
					];
				SaveGuide[pattern,dir,
					Sequence@@
						DeleteDuplicatesBy[First]@
						FilterRules[{
							"RelatedGuides"->
								DeleteCases[
									Replace[OptionValue@"RelatedGuides",Automatic->{}],
									linkbase->linkbase|(linkbase<>"/guide/"<>linkbase)
									],
								ops
								},
							Options@SaveGuide
							]
					]
				];
			If[
				Replace[OptionValue["Index"],
					Automatic->
						OptionValue@"Install"],
				IndexDocumentation[dir]
				];
			If[OptionValue["Install"]//TrueQ,
				PacletManager`PacletDirectoryRemove@
					Replace[base,
						Automatic:>
							FileNameJoin@{
								$TemporaryDirectory,
								"doc_paclets"
								}
						];
				PacletExpressionBundle[pacletBase,
					"Version"->"0",
					"Kernel"->None,
					"FrontEnd"->None,
					"Resource"->None
					];
				PacletManager`PacletInstall[
					PacletBundle[pacletBase,
						"BuildRoot"->
							Replace[base,
								Automatic:>
									FileNameJoin@{
										$TemporaryDirectory,
										"doc_paclets"
										}
								]
						],
					"IgnoreVersion"->True
					],
				If[open,
					PacletManager`PacletDirectoryAdd@
						Replace[base,
							Automatic:>
								FileNameJoin@{
									$TemporaryDirectory,
									"doc_paclets"
									}
							]
					]
				];
			If[open,
				SystemOpen@
					URLBuild[<|
						"Scheme"->"paclet",
						"Path"->{
							StringReplace[pattern,Except["$"|WordCharacter]->""],
							"guide",
							StringReplace[pattern,Except["$"|WordCharacter]->""]
							}
						|>],
				If[TrueQ@OptionValue@"Install",
					PacletManager`PacletFind[
						Lookup[
							PacletInfoAssociation@pacletBase,
							{"Name","Version"}
							]
						],
					pacletBase
					]
				]
			]
		];


Options[GenerateDocumentation]=
	Options[generateDocumentation];
GenerateDocumentation[
	patterns:{__String},
	base:_String?DirectoryQ|Automatic:Automatic,
	open:True|False:True,
	ops:OptionsPattern[]
	]:=
	With[{
		linkBases=
			StringReplace[
				patterns,
				Except[WordCharacter]->""
				]
			},
		If[open,Null&,Identity]@
		Block[{
			$ContextPath=
				Join[$ContextPath,
					Select[patterns,StringEndsQ["`"]]
					]
			},
			MapThread[
				Monitor[
					generateDocumentation[#,
						base,
						If[#2===Last@linkBases,open,False],
						ops,
						"RelatedGuides"->
							Map[#->(#<>"/guide/"<>#)&,linkBases]
						],
					Internal`LoadingPanel@
						TemplateApply[
							"Generating `` documentation",
							#2
							]
					]&,
					{
						patterns,
						linkBases
						}
				]
			]
		];
GenerateDocumentation[
	patterns_String,
	base:_String?DirectoryQ|Automatic:Automatic,
	open:True|False:True,
	ops:OptionsPattern[]
	]:=
	GenerateDocumentation[{patterns},
		base,
		open,
		ops
		]


DocAddUsage[sym_Symbol,usage_String]:=
	(sym::usages=
		StringTrim@
			StringRiffle[{
				StringReplace[
					Replace[sym::usages,
						Except[_String]->""
						],
					usage->""
					],
				usage},
				"\n"]);
DocAddUsage[pat:Except[_Missing],usage_String]:=
	DocAddUsage[
		Evaluate@
			FirstCase[Hold[pat],
				s_Symbol?(
					Function[Null,
						!MatchQ[Context[#],"System`"|"Global`"],
						HoldFirst]):>s,
				Missing["NotFound"],
				Infinity,
				Heads->True
				],
		ToString[Unevaluated[pat]]<>" "<>usage
		];
DocAddUsage[pat:Except[_Missing],usage_]:=
	DocAddUsage[pat,ToString[usage]];
DocAddUsage~SetAttributes~HoldFirst;


End[];



